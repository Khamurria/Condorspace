    <!-- === INIZIO BLOCCO 6 (JavaScript Game Logic Functions) === -->
    <script>
        // --- Funzione per assegnare elementi DOM ---
        function assignElements() {
             try {
                 canvas = document.getElementById('gameCanvas'); if (!canvas) throw new Error("Elemento canvas non trovato"); ctx = canvas.getContext('2d'); if (!ctx) throw new Error("Impossibile ottenere contesto 2D");
                 startButton = document.getElementById('startButton'); gameOverOverlay = document.getElementById('gameOverOverlay'); restartButton = document.getElementById('restartButton'); finalScoreUI = document.getElementById('finalScore'); highScoreEntryUI = document.getElementById('highScoreEntry'); playerNameInput = document.getElementById('playerNameInput'); saveScoreButton = document.getElementById('saveScoreButton'); highScoreListUI = document.getElementById('highScoreList'); scoreValueUI = document.getElementById('scoreValue'); livesValueUI = document.getElementById('livesValue'); weaponValueUI = document.getElementById('weaponValue'); levelValueUI = document.getElementById('levelValue'); statusValueUI = document.getElementById('statusValue'); waveValueUI = document.getElementById('waveValue'); enemiesValueUI = document.getElementById('enemiesValue'); pauseOverlay = document.getElementById('pauseOverlay'); uiMessageDisplay = document.getElementById('uiMessageDisplay'); healthValueUI = document.getElementById('healthValue'); healthBarUI = document.getElementById('healthBar'); healthBarContainer = document.getElementById('healthBarContainer'); bossHealthBarContainer = document.getElementById('bossHealthBarContainer'); bossHealthBar = document.getElementById('bossHealthBar'); bossHealthText = document.getElementById('bossHealthText'); introOverlay = document.getElementById('introOverlay'); skipIntroButton = document.getElementById('skipIntroButton'); mainLayout = document.getElementById('mainLayout'); titleLogoCanvas = document.getElementById('titleLogoCanvas'); cadetRegistrationScreen = document.getElementById('cadetRegistrationScreen'); cadetRegistrationContainer = document.getElementById('cadetRegistrationContainer'); cadetNameDisplayUI = document.getElementById('cadetNameDisplay');
                 if (!startButton || !gameOverOverlay || !scoreValueUI || !mainLayout || !introOverlay || !canvas || !ctx || !titleLogoCanvas || !cadetRegistrationScreen || !cadetRegistrationContainer) {
                      console.warn("WARN: Uno o pi√π elementi UI principali non trovati durante l'assegnazione.");
                 }
                 console.log("INFO: Elementi DOM assegnati."); return true;
             } catch (error) { console.error("FATAL: Errore assegnazione elementi DOM:", error.message); alert("Errore di inizializzazione critico: " + error.message); return false; }
         }

        // --- Funzioni di Disegno Specifiche ---
        function drawCondorspaceTitleLogo(canvasElement) { if(!canvasElement)return;const ctxLogo=canvasElement.getContext('2d');if(!ctxLogo)return;const w=canvasElement.width;const h=canvasElement.height;ctxLogo.clearRect(0,0,w,h);const scale=Math.min(w/100,h/80);const cX=w/2;const cY=h/2+h*0.05;ctxLogo.save();ctxLogo.translate(cX,cY);ctxLogo.scale(scale,scale);ctxLogo.beginPath();ctxLogo.fillStyle='#2a4b8d';ctxLogo.moveTo(0,-35);ctxLogo.lineTo(-25,25);ctxLogo.lineTo(25,25);ctxLogo.closePath();ctxLogo.fill();ctxLogo.strokeStyle='#49daff';ctxLogo.lineWidth=2/scale;ctxLogo.stroke();ctxLogo.beginPath();ctxLogo.moveTo(-25,10);ctxLogo.lineTo(-45,30);ctxLogo.lineTo(-25,25);ctxLogo.closePath();ctxLogo.fill();ctxLogo.stroke();ctxLogo.beginPath();ctxLogo.moveTo(25,10);ctxLogo.lineTo(45,30);ctxLogo.lineTo(25,25);ctxLogo.closePath();ctxLogo.fill();ctxLogo.stroke();ctxLogo.beginPath();ctxLogo.moveTo(0,-25);ctxLogo.lineTo(-10,0);ctxLogo.lineTo(10,0);ctxLogo.closePath();ctxLogo.fillStyle='#6ab7ff';ctxLogo.fill();ctxLogo.stroke();ctxLogo.fillStyle='#ff9f1c';ctxLogo.beginPath();ctxLogo.moveTo(-15,25);ctxLogo.lineTo(-10,40);ctxLogo.lineTo(0,25);ctxLogo.closePath();ctxLogo.fill();ctxLogo.beginPath();ctxLogo.moveTo(15,25);ctxLogo.lineTo(10,40);ctxLogo.lineTo(0,25);ctxLogo.closePath();ctxLogo.fill();ctxLogo.shadowColor='#49daff';ctxLogo.shadowBlur=10/scale;ctxLogo.strokeStyle='rgba(73,218,255,0.6)';ctxLogo.lineWidth=1/scale;ctxLogo.beginPath();ctxLogo.arc(0,0,60,0,Math.PI*2);ctxLogo.stroke();ctxLogo.restore();}
        function drawSpaceship(){if(!spaceship.isAlive||!isSpaceshipCurrentlyVisible()||!ctx)return;ctx.save();const cX=spaceship.x+spaceship.width/2;const cY=spaceship.y+spaceship.height/2;if(spaceship.shieldActive){const sMaxR=spaceship.width*0.8;const sPulse=Math.sin(game.animationFrame*0.08)*4;const cR=sMaxR+sPulse;const sAlpha=0.4+Math.sin(game.animationFrame*0.1)*0.15;const fadeF=Math.min(1,spaceship.shieldTimer/(spaceship.SHIELD_DURATION*0.3));ctx.globalAlpha=sAlpha*fadeF;const grad=ctx.createRadialGradient(cX,cY,cR*0.5,cX,cY,cR);grad.addColorStop(0,"rgba(180,220,255,0.1)");grad.addColorStop(0.7,"rgba(100,180,255,0.6)");grad.addColorStop(1,"rgba(50,120,200,0.3)");ctx.fillStyle=grad;ctx.beginPath();ctx.arc(cX,cY,cR,0,Math.PI*2);ctx.fill();ctx.strokeStyle=`rgba(200,230,255,${0.7*fadeF})`;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(cX,cY,cR,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1.0;}const sBG=ctx.createLinearGradient(spaceship.x,spaceship.y,spaceship.x+spaceship.width,spaceship.y+spaceship.height);sBG.addColorStop(0,"#1e5799");sBG.addColorStop(0.4,"#207cca");sBG.addColorStop(0.6,"#2989d8");sBG.addColorStop(1,"#1e5799");ctx.fillStyle=sBG;ctx.beginPath();ctx.moveTo(spaceship.x+spaceship.width*0.2,spaceship.y+15);ctx.bezierCurveTo(spaceship.x+spaceship.width*0.35,spaceship.y,spaceship.x+spaceship.width*0.65,spaceship.y,spaceship.x+spaceship.width*0.8,spaceship.y+15);ctx.lineTo(spaceship.x+spaceship.width,spaceship.y+spaceship.height*0.7);ctx.lineTo(spaceship.x+spaceship.width*0.8,spaceship.y+spaceship.height);ctx.lineTo(spaceship.x+spaceship.width*0.2,spaceship.y+spaceship.height);ctx.lineTo(spaceship.x,spaceship.y+spaceship.height*0.7);ctx.closePath();ctx.fill();const wG=ctx.createLinearGradient(spaceship.x-15,spaceship.y+spaceship.height*0.6,spaceship.x+15,spaceship.y+spaceship.height*0.8);wG.addColorStop(0,"#00356b");wG.addColorStop(0.5,"#1a6bbf");wG.addColorStop(1,"#3498db");const rWG=ctx.createLinearGradient(spaceship.x+spaceship.width+15,spaceship.y+spaceship.height*0.6,spaceship.x+spaceship.width-15,spaceship.y+spaceship.height*0.8);rWG.addColorStop(0,"#00356b");rWG.addColorStop(0.5,"#1a6bbf");rWG.addColorStop(1,"#3498db");ctx.fillStyle=wG;ctx.beginPath();ctx.moveTo(spaceship.x,spaceship.y+spaceship.height*0.7);ctx.lineTo(spaceship.x-20,spaceship.y+spaceship.height*0.85);ctx.lineTo(spaceship.x-10,spaceship.y+spaceship.height*0.95);ctx.lineTo(spaceship.x,spaceship.y+spaceship.height*0.9);ctx.closePath();ctx.fill();ctx.fillStyle=rWG;ctx.beginPath();ctx.moveTo(spaceship.x+spaceship.width,spaceship.y+spaceship.height*0.7);ctx.lineTo(spaceship.x+spaceship.width+20,spaceship.y+spaceship.height*0.85);ctx.lineTo(spaceship.x+spaceship.width+10,spaceship.y+spaceship.height*0.95);ctx.lineTo(spaceship.x+spaceship.width,spaceship.y+spaceship.height*0.9);ctx.closePath();ctx.fill();const eR=spaceship.width*0.28;const eY=spaceship.y+spaceship.height*0.35;ctx.fillStyle="#207cca";ctx.beginPath();ctx.arc(cX,eY,eR,0,Math.PI*2);ctx.fill();const eG=ctx.createRadialGradient(cX,eY,0,cX,eY,eR*0.85);eG.addColorStop(0,"#ffe066");eG.addColorStop(0.5,"#ff9f1c");eG.addColorStop(1,"#f77f00");ctx.fillStyle=eG;ctx.beginPath();ctx.arc(cX,eY,eR*0.85,0,Math.PI*2);ctx.fill();ctx.fillStyle="rgba(255,255,255,0.8)";ctx.beginPath();ctx.arc(cX+eR*0.4,eY-eR*0.3,eR*0.15,0,Math.PI*2);ctx.fill();ctx.fillStyle="rgba(255,255,255,0.6)";ctx.beginPath();ctx.arc(cX-eR*0.25,eY+eR*0.3,eR*0.1,0,Math.PI*2);ctx.fill();const nH=spaceship.height*0.18;const nW=spaceship.width*0.5;const nY=spaceship.y+spaceship.height*0.85;const nG=ctx.createLinearGradient(cX-nW/2,nY,cX+nW/2,nY+nH);nG.addColorStop(0,"#8899aa");nG.addColorStop(0.5,"#cdd0d4");nG.addColorStop(1,"#667788");ctx.fillStyle=nG;ctx.beginPath();ctx.moveTo(cX-nW/2,nY);ctx.lineTo(cX+nW/2,nY);ctx.lineTo(cX+nW*0.35,nY+nH);ctx.lineTo(cX-nW*0.35,nY+nH);ctx.closePath();ctx.fill();const thrustM=0.5+spaceship.thrustPower*0.8;const flSY=nY+nH*0.5;const flG=ctx.createLinearGradient(cX,flSY,cX,flSY+30*thrustM);flG.addColorStop(0,"#00ffff");flG.addColorStop(0.5,"#0066ff");flG.addColorStop(1,"rgba(0,40,255,0)");const flW=20*(0.8+Math.sin(spaceship.engineAnimFrame/2)*0.2)*thrustM;const flH=(20+10*spaceship.engineAnimFrame*0.8)*thrustM*1.5;if(thrustM>0.05&&flH>1){ctx.shadowColor="#0af";ctx.shadowBlur=10+10*spaceship.thrustPower;ctx.fillStyle=flG;ctx.beginPath();ctx.moveTo(cX-flW/2,flSY-5);ctx.quadraticCurveTo(cX,flSY+flH*1.5,cX+flW/2,flSY-5);ctx.closePath();ctx.fill();ctx.shadowBlur=0;}ctx.strokeStyle="#ff9f1c";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(spaceship.x-15,spaceship.y+spaceship.height*0.75);ctx.lineTo(spaceship.x-5,spaceship.y+spaceship.height*0.85);ctx.stroke();ctx.beginPath();ctx.moveTo(spaceship.x+spaceship.width+15,spaceship.y+spaceship.height*0.75);ctx.lineTo(spaceship.x+spaceship.width+5,spaceship.y+spaceship.height*0.85);ctx.stroke();ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(cX,spaceship.y+spaceship.height*0.7);ctx.lineTo(cX,spaceship.y+spaceship.height*0.95);ctx.stroke();ctx.restore();}
        function drawProjectiles(t){const a=game.animationFrame;for(let i of t)if(i.active)i.draw(a)}
        function drawAliens(){for(let t of game.aliens)if(t.active)t.draw()}
        function drawPowerUps(){for(let t of game.powerUps)if(t.active)t.draw()}
        function drawExplosions(){for(let t of game.explosions)if(t.active)t.draw(ctx)}
        function drawStars(ctx, stars){if(!ctx)return;ctx.save();stars.forEach(s=>{const z=s.size*(0.5+s.z*0.5);const a=0.3+s.z*0.7;ctx.fillStyle=`rgba(255,255,255,${a})`;ctx.beginPath();ctx.arc(s.x,s.y,z,0,Math.PI*2);ctx.fill();});ctx.restore();}
        function drawPlanets(ctx, planets){if(!ctx)return;planets.sort((a,b)=>a.depth-b.depth);planets.forEach(p=>p.draw());}
        function drawNebulosities(){if(!ctx)return;ctx.globalCompositeOperation="lighter";ctx.globalAlpha=.6;const oX=Math.sin(game.animationFrame*6e-4)*180,oY=Math.cos(game.animationFrame*7e-4)*120;const dN=(x,y,r,c1,c2,c3)=>{try{const g=ctx.createRadialGradient(x,y,r*.05,x,y,r);g.addColorStop(0,c1);g.addColorStop(.5,c2);g.addColorStop(1,c3);ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,r,0,2*Math.PI);ctx.fill()}catch(e){}};dN(canvas.width*.7+oX,canvas.height*.3+oY,320,"rgba(100,0,155,0.06)","rgba(50,0,80,0.04)","rgba(0,0,30,0)");dN(canvas.width*.2-oX,canvas.height*.7-oY,280,"rgba(0,50,155,0.07)","rgba(20,40,120,0.04)","rgba(0,0,30,0)");dN(canvas.width*.8+oX*.5,canvas.height*.8-oY*.7,240,"rgba(155,30,0,0.05)","rgba(100,20,0,0.03)","rgba(30,0,0,0)");dN(canvas.width*.3-oX*.8,canvas.height*.2+oY*.6,200,"rgba(0,155,100,0.04)","rgba(0,100,80,0.02)","rgba(0,30,20,0)");ctx.fillStyle="rgba(200,200,220,0.03)";for(let i=0;i<80;i++){const pX=(pseudoRandom()*1.2*canvas.width-canvas.width*.1+oX*.2)%canvas.width,pY=(pseudoRandom()*1.2*canvas.height-canvas.height*.1+oY*.2)%canvas.height,pS=pseudoRandom()*.8+.2;ctx.fillRect(pX,pY,pS,pS)}ctx.globalCompositeOperation="source-over";ctx.globalAlpha=1;}
        function drawLaserBeam(){if(!spaceship.laserBeamActive||!spaceship.isAlive||!isSpaceshipCurrentlyVisible()||!ctx)return;const beamX=spaceship.x+spaceship.width/2;const beamY0=spaceship.y;const beamY1=0;const beamW=8+Math.sin(game.animationFrame*0.2)*2;ctx.save();ctx.globalCompositeOperation='lighter';const grad=ctx.createLinearGradient(beamX,beamY0,beamX,beamY1);try{grad.addColorStop(0,"rgba(255,0,102,0.1)");grad.addColorStop(0.1,"#ff80b3");grad.addColorStop(0.9,"#ff0066");grad.addColorStop(1,"rgba(255,255,255,0.8)");}catch{grad.addColorStop(0,"#ff80b3");grad.addColorStop(1,"#ff0066");}ctx.strokeStyle=grad;ctx.lineWidth=beamW;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(beamX,beamY0);ctx.lineTo(beamX,beamY1);ctx.stroke();ctx.lineWidth=beamW*0.5;try{ctx.strokeStyle=hexToRgba("#ff0066",0.4);}catch{ctx.strokeStyle="rgba(255,150,200,0.4)";}ctx.stroke();ctx.restore();}
        function drawBackground(){if(!ctx||!canvas)return;const grad=ctx.createLinearGradient(0,0,0,canvas.height);grad.addColorStop(0,"#000018");grad.addColorStop(.5,"#050520");grad.addColorStop(1,"#000010");ctx.fillStyle=grad;ctx.fillRect(0,0,canvas.width,canvas.height);drawStars(ctx,game.stars);drawNebulosities();drawPlanets(ctx,game.planets);}
        function drawUIEffects(){if(!ctx)return;if(game.screenFlashTimer>0){const alpha=Math.min(0.6,(game.screenFlashTimer/SCREEN_FLASH_DURATION)*0.6);ctx.fillStyle=`rgba(255,180,180,${alpha})`;ctx.fillRect(0,0,canvas.width,canvas.height);}}
        function drawPauseScreen(){if(pauseOverlay)pauseOverlay.classList.add('visible');}
        function drawBossHealth(){if(!gameBoss||!gameBoss.active){if(bossHealthBarContainer&&bossHealthBarContainer.style.display!=='none')bossHealthBarContainer.style.display='none';return;}if(bossHealthBarContainer&&bossHealthBarContainer.style.display==='none')bossHealthBarContainer.style.display='block';gameBoss.updateTotalHealth();}

        // --- Funzioni di Aggiornamento Stato ---
        function updateSpaceship(deltaTime){if(!spaceship.isAlive)return;const dtS=deltaTime/1000;if(spaceship.invincibleAfterHit){spaceship.hitInvincibleTimer-=deltaTime;if(spaceship.hitInvincibleTimer<=0)spaceship.invincibleAfterHit=false;}if(spaceship.invincibleAfterLifeLoss){spaceship.lifeLossInvincibleTimer-=deltaTime;if(spaceship.lifeLossInvincibleTimer<=0)spaceship.invincibleAfterLifeLoss=false;}if(spaceship.shieldActive){spaceship.shieldTimer-=deltaTime;if(spaceship.shieldTimer<=0){spaceship.shieldActive=false;AudioSystem.playShieldDownSound();updateGameUI(game,spaceship);}}if(spaceship.fireDelay>0)spaceship.fireDelay-=deltaTime;let mX=0,mY=0;if(spaceship.moveLeft)mX-=1;if(spaceship.moveRight)mX+=1;if(spaceship.moveUp)mY-=1;if(spaceship.moveDown)mY+=1;const mag=Math.sqrt(mX*mX+mY*mY);if(mag>0){mX=(mX/mag)*spaceship.speed*dtS;mY=(mY/mag)*spaceship.speed*dtS;}spaceship.x+=mX;spaceship.y+=mY;spaceship.x=Math.max(0,Math.min(canvas.width-spaceship.width,spaceship.x));spaceship.y=Math.max(0,Math.min(canvas.height-spaceship.height,spaceship.y));spaceship.thrustPower=(mX!==0||mY!==0)?1:0;if(spaceship.firing&&spaceship.fireDelay<=0){switch(spaceship.weaponType){case 0:game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-3,spaceship.y,0));spaceship.fireDelay=spaceship.fireRate;AudioSystem.playLaserSound();break;case 1:const sA=Math.PI/12;game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-2.5,spaceship.y,1,0));game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width*0.2,spaceship.y,1,-sA));game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width*0.8-5,spaceship.y,1,sA));spaceship.fireDelay=spaceship.fireRate*1.4;AudioSystem.playSpreadSound();break;case 2:game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-2,spaceship.y,2));spaceship.fireDelay=spaceship.fireRate*0.5;AudioSystem.playRapidSound();break;case 3:game.playerProjectiles.push(new Projectile(spaceship.x+spaceship.width/2-5,spaceship.y-10,3));spaceship.fireDelay=spaceship.fireRate*1.8;AudioSystem.playHeavySound();break;case 4:if(!spaceship.laserBeamActive){spaceship.laserBeamActive=true;AudioSystem.startContinuous();}break;}}if(!spaceship.firing&&spaceship.laserBeamActive){spaceship.laserBeamActive=false;AudioSystem.stopContinuous();}if(spaceship.laserBeamActive){const lX=spaceship.x+spaceship.width/2;const lY0=spaceship.y;const lY1=0;const lW=10;const lRect={x:lX-lW/2,y:lY1,width:lW,height:lY0-lY1};game.aliens.forEach(a=>{if(a.active&&isColliding(lRect,a)){const d=LASER_DPS*dtS;if(a.takeDamage(d)){}game.explosions.push(new Explosion(lX,a.y+a.height/2,5+Math.random()*5,{primary:'#ff80b3',energy:'#fff',type:'custom',life:0.1,decay:0.1},'custom'));}});if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){const bRect={x:gameBoss.x-gameBoss.width/2,y:gameBoss.y-gameBoss.height/2,width:gameBoss.width,height:gameBoss.height};if(isColliding(lRect,bRect)){const d=LASER_DPS*dtS;const hY=Math.max(lRect.y,bRect.y+Math.abs(lX-gameBoss.x)*0.1);gameBoss.takeDamage(d,lX,hY);game.explosions.push(new Explosion(lX,hY,8+Math.random()*8,{primary:'#ff80b3',energy:'#fff',type:'custom',life:0.1,decay:0.1},'custom'));}}}}
        function updateProjectiles(projectiles,deltaTime){for(let i=projectiles.length-1;i>=0;i--){projectiles[i].update(deltaTime);if(!projectiles[i].active)projectiles.splice(i,1);}}
        function updateAliens(deltaTime){for(let i=game.aliens.length-1;i>=0;i--){if(!game.aliens[i].update(deltaTime))game.aliens.splice(i,1);}}
        function updatePowerUps(deltaTime){for(let i=game.powerUps.length-1;i>=0;i--){game.powerUps[i].update(deltaTime);if(!game.powerUps[i].active)game.powerUps.splice(i,1);}}
        function updateExplosions(deltaTime){for(let i=game.explosions.length-1;i>=0;i--){try{if(!game.explosions[i].update(deltaTime))game.explosions.splice(i,1);}catch(e){console.error("Err upd explosion:",e);game.explosions.splice(i,1);}}}
        function updateStars(stars,speed,canvasHeight,deltaTime){stars.forEach(s=>{s.y+=speed*s.z*deltaTime/16;if(s.y>canvasHeight){s.y=-Math.random()*50;s.x=Math.random()*canvas.width;s.z=Math.random();s.size=1+Math.random()*1.5;}});}
        function updatePlanets(planets,deltaTime){for(let i=planets.length-1;i>=0;i--){if(!planets[i].update(deltaTime))planets.splice(i,1);}if(planets.length<MAX_PLANETS&&Math.random()<0.001*(deltaTime/16))spawnPlanet();}
        function updateBoss(bossInstance,deltaTime){if(bossInstance&&bossInstance.active)bossInstance.update(deltaTime);}
        function updateUIState(deltaTime){if(game.uiMessageTimer>0){game.uiMessageTimer-=deltaTime;if(game.uiMessageTimer<=0){uiMessageDisplay.classList.remove('visible');game.uiMessage="";}else if(!uiMessageDisplay.classList.contains('visible')){uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add('visible');}}if(game.screenFlashTimer>0)game.screenFlashTimer-=deltaTime;}
        function updateGameUI(gameData,shipData){if(scoreValueUI)scoreValueUI.textContent=gameData.score;if(livesValueUI)livesValueUI.textContent=gameData.lives;if(healthValueUI&&healthBarUI){const hT=`${shipData.health}/${shipData.maxHealth}`;healthValueUI.textContent=hT;const hP=(shipData.health/shipData.maxHealth)*100;healthBarUI.style.width=`${hP}%`;if(hP>60)healthBarUI.style.backgroundColor='#40ff40';else if(hP>30)healthBarUI.style.backgroundColor='#ffff40';else healthBarUI.style.backgroundColor='#ff4040';}if(weaponValueUI){let wN="Standard";switch(shipData.weaponType){case 1:wN="Spread";break;case 2:wN="Rapid";break;case 3:wN="Heavy";break;case 4:wN="Laser";break;}weaponValueUI.textContent=wN;}if(levelValueUI)levelValueUI.textContent=gameData.level;if(waveValueUI){if(gameData.bossSpawned)waveValueUI.textContent="BOSS";else if(gameData.allWavesCompleted)waveValueUI.textContent="???";else if(gameData.currentWaveIndex>=0&&gameData.currentWaveIndex<WAVES.length)waveValueUI.textContent=`${gameData.currentWaveIndex+1}/${WAVES.length}`;else waveValueUI.textContent="-";}if(statusValueUI){if(shipData.shieldActive){statusValueUI.textContent="SCUDO";statusValueUI.classList.add('shieldActiveUI');}else if(shipData.invincibleAfterHit||shipData.invincibleAfterLifeLoss){statusValueUI.textContent="INV.";statusValueUI.classList.remove('shieldActiveUI');}else{statusValueUI.textContent="OK";statusValueUI.classList.remove('shieldActiveUI');}}if(enemiesValueUI)enemiesValueUI.textContent=gameData.aliens.filter(a=>a.active).length+(gameBoss&&gameBoss.active?1:0);if(cadetNameDisplayUI)cadetNameDisplayUI.textContent=gameData.cadetName;}

        // --- Gestione Input ---
        function handleKeyDown(event){if(game.isGameOver)return;if(event.key.toUpperCase()==='P'){togglePause();event.preventDefault();return;}if(!game.running||game.paused)return;let p=true;switch(event.key.toUpperCase()){case"ARROWLEFT":case"A":spaceship.moveLeft=true;break;case"ARROWRIGHT":case"D":spaceship.moveRight=true;break;case"ARROWUP":case"W":spaceship.moveUp=true;break;case"ARROWDOWN":case"S":spaceship.moveDown=true;break;case" ":spaceship.firing=true;break;default:p=false;break;}if(p)event.preventDefault();}
        function handleKeyUp(event){switch(event.key.toUpperCase()){case"ARROWLEFT":case"A":spaceship.moveLeft=false;break;case"ARROWRIGHT":case"D":spaceship.moveRight=false;break;case"ARROWUP":case"W":spaceship.moveUp=false;break;case"ARROWDOWN":case"S":spaceship.moveDown=false;break;case" ":spaceship.firing=false;break;}}

        // --- Logica High Score ---
        function loadHighScores(){try{const s=localStorage.getItem(HIGH_SCORE_KEY);return s?JSON.parse(s):[];}catch(e){console.error("Err load scores:",e);localStorage.removeItem(HIGH_SCORE_KEY);return[];}}
        function saveHighScore(){const name=playerNameInput.value.trim().toUpperCase();if(name.length<3||name.length>10||!/^[A-Z0-9]+$/.test(name)){alert("Nome non valido (3-10 A-Z, 0-9).");playerNameInput.focus();playerNameInput.select();return;}if(game.currentScoreSubmitted){console.warn("Score gi√† salvato.");return;}AudioSystem.playButtonSound();const scores=loadHighScores();scores.push({name:name,score:game.score,defeatedBoss:game.bossDefeated});scores.sort((a,b)=>b.score-a.score);try{localStorage.setItem(HIGH_SCORE_KEY,JSON.stringify(scores.slice(0,MAX_HIGH_SCORES)));console.log("HS salvato:",{name,score:game.score});game.currentScoreSubmitted=true;highScoreEntryUI.style.display='none';restartButton.style.display='block';saveScoreButton.style.display='none';displayHighScores();}catch(e){console.error("Err save scores:",e);alert("Errore salvataggio score.");}}
        function displayHighScores(){if(!highScoreListUI)return;const scores=loadHighScores();highScoreListUI.innerHTML='';if(scores.length===0){highScoreListUI.innerHTML='<li><span>NESSUN RECORD</span><span></span></li>';}else{scores.forEach((entry,index)=>{const li=document.createElement('li');const nameSpan=document.createElement('span');let dN=String(entry.name||"???").replace(/</g,"&lt;").replace(/>/g,"&gt;");if(entry.defeatedBoss)dN+=' <span title="CMDR Scuderi Sconfitto!">üèÜ</span>';nameSpan.innerHTML=dN;const scoreSpan=document.createElement('span');scoreSpan.textContent=entry.score||0;li.appendChild(nameSpan);li.appendChild(scoreSpan);if(entry.defeatedBoss){li.style.background="linear-gradient(90deg, rgba(255,215,0,0.25) 0%, rgba(255,215,0,0.05) 100%)";li.style.borderLeft="3px solid #ffd700";nameSpan.style.color="#fff";scoreSpan.style.color="#ffffaa";}highScoreListUI.appendChild(li);});}}
        function checkHighScore(score){const scores=loadHighScores();return scores.length<MAX_HIGH_SCORES||score>(scores[scores.length-1]?.score??0);}
        function submitHighScore(){saveHighScore();}

        // --- Funzioni Logica Cristalli (Esagonali - chiamate gi√† definite nel Blocco 5) ---
        // Le definizioni di createCrystalCollectEffect, playCrystalCollectSound, spawnCrystalsFromAlien,
        // initCrystalSystem, updateCrystals, drawCrystals sono nel Blocco 5.

        // --- Funzioni Spawn Entit√† ---
        function createStars(){game.stars=[];for(let i=0;i<starCount;i++){game.stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,z:Math.random(),size:1+Math.random()*1.5});}}
        function createInitialPlanets(){if(typeof Planet==='undefined'){console.error("Planet non definita in createInitialPlanets");return;}game.planets=[];currentPlanetTypes=[];for(let i=0;i<Math.floor(MAX_PLANETS/2);i++)spawnPlanet(Math.random()*canvas.height);}
        function spawnPlanet(startY=-200){if(typeof Planet==='undefined'){console.error("Planet non definita in spawnPlanet");return;}if(game.planets.length>=MAX_PLANETS)return;let availT=availablePlanetTypes.filter(t=>!currentPlanetTypes.includes(t));if(availT.length===0)availT=availablePlanetTypes;const type=availT[Math.floor(Math.random()*availT.length)];currentPlanetTypes.push(type);const depth=0.3+Math.random()*0.7;const size=80+(1-depth)*150;const x=Math.random()*canvas.width;const y=startY-size;game.planets.push(new Planet(x,y,size,type,depth));}
        function spawnAlien(wave){if(!wave||!wave.alienTypes||wave.alienTypes.length===0)return;const typeData=wave.alienTypes[Math.floor(Math.random()*wave.alienTypes.length)];const params=typeData.params;const type=typeData.type;const health=params.health*(1+game.level*0.1);const speedY=params.speedY*(1+game.level*0.05);const shootCooldown=Math.max(500,params.shootCooldown/(1+game.level*0.1));const size=(params.sizeMultiplier||1)*(20+Math.random()*15);const x=Math.random()*(canvas.width-size*2)+size;const y=-size-Math.random()*50;const colors=getRandomColor();game.aliens.push(new Alien(x,y,size,colors,params.movement,{...params,health,speedY,shootCooldown}));}
        function spawnPowerUp(x,y){const r=Math.random();let type;if(r<0.15)type=6;else if(r<0.30)type=5;else if(r<0.50)type=1;else if(r<0.70)type=2;else if(r<0.85)type=3;else type=4;if(game.powerUps.length<4)game.powerUps.push(new PowerUp(x,y,type));}
        function spawnBoss(){if(!gameBoss&&!game.bossSpawned&&!game.bossDefeated){console.log("INFO: Inizio spawn Boss!");gameBoss=new Boss();gameBoss.spawn();}else{console.warn("WARN: Tentativo spawn boss ma √® gi√† presente/sconfitto.");}}
        function createBossExplosion(x,y,size){console.log("INFO: Creazione esplosione finale Boss");const bossColors={primary:"#ff4400",secondary:"#ffaa00",accent:"#ffffff",glow:"#ff6600",energy:"#ffff88"};game.screenFlashTimer=500;for(let i=0;i<5;i++){setTimeout(()=>{if(game.isGameOver)return;const ex=x+(Math.random()-0.5)*size*0.6;const ey=y+(Math.random()-0.5)*size*0.4;const sz=size*(0.8+Math.random()*0.5);game.explosions.push(new Explosion(ex,ey,sz,bossColors,'large'));if(AudioSystem&&i>0)AudioSystem.playExplosionSound('large');},i*300);}setTimeout(()=>{game.explosions.push(new Explosion(x,y,size*1.5,DEFAULT_EXPLOSION_COLORS,'large'));},1500);}

        // --- Funzioni Gestione Stato Gioco ---
        function initializeGame(){console.log("INFO: Inizializzazione gioco post-registrazione...");if(!assignElements())return;AudioSystem.init();window.addEventListener('keydown',handleKeyDown);window.addEventListener('keyup',handleKeyUp);canvas.addEventListener('contextmenu',(e)=>e.preventDefault());setupButtonListeners();loadHighScores();displayHighScores();initCrystalSystem();resetGame();createStars();createInitialPlanets();updateGameUI(game,spaceship);if(titleLogoCanvas)drawCondorspaceTitleLogo(titleLogoCanvas);mainLayout.classList.add('visible');startButton.style.display='block';startButton.disabled=false;canvas.focus();console.log("INFO: Init gioco completato.");}
        function startGame(){console.log("INFO: Avvio partita...");if(game.running&&!game.paused)return;AudioSystem.playButtonSound();gameOverOverlay.style.display='none';startButton.style.display='none';pauseOverlay.classList.remove('visible');resetGame();AudioSystem.playGameStartSound();if(AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){AudioSystem.stopAllMP3Music(200);setTimeout(()=>{if(game.running&&!game.paused&&!game.bossSpawned)AudioSystem.playGameplayMP3();},300);}game.running=true;game.paused=false;game.isGameOver=false;game.lastTime=performance.now();if(animationFrameId===null){gameLoop(game.lastTime);console.log("INFO: Game loop avviato.");}else{console.log("INFO: Gioco ripreso.");}canvas.focus();}
        function resetGame(){console.log("INFO: Reset gioco.");game.score=0;game.lives=3;game.level=1;game.currentWaveIndex=-1;game.waveTimer=0;game.timeUntilNextWave=3000;game.inWavePause=true;game.allWavesCompleted=false;game.bossSpawned=false;game.bossDefeated=false;game.alienSpawnTimer=0;game.errorNotified=false;game.playerProjectiles=[];game.aliens=[];game.alienProjectiles=[];game.explosions=[];game.powerUps=[];game.crystals=[];game.currentScoreSubmitted=false;spaceship.x=canvas.width/2-spaceship.width/2;spaceship.y=canvas.height-spaceship.height-20;spaceship.health=spaceship.maxHealth;spaceship.weaponType=0;spaceship.isAlive=true;spaceship.shieldActive=false;spaceship.shieldTimer=0;spaceship.invincibleAfterHit=false;spaceship.invincibleAfterLifeLoss=false;spaceship.hitInvincibleTimer=0;spaceship.lifeLossInvincibleTimer=0;spaceship.laserBeamActive=false;if(AudioSystem)AudioSystem.stopContinuous();gameBoss=null;updateGameUI(game,spaceship);if(bossHealthBarContainer)bossHealthBarContainer.style.display='none';}
        function pauseGame(){if(!game.paused&&game.running&&!game.isGameOver){game.paused=true;if(AudioSystem)AudioSystem.stopContinuous();console.log("PAUSA");pauseOverlay.classList.add('visible');}}
        function resumeGame(){if(game.paused&&game.running&&!game.isGameOver){game.paused=false;pauseOverlay.classList.remove('visible');AudioSystem.resumeContext(()=>{if(game.bossSpawned&&!game.bossDefeated)AudioSystem.playBossMP3();else if(game.running&&!game.allWavesCompleted)AudioSystem.playGameplayMP3();if(spaceship.firing&&spaceship.weaponType===4&&spaceship.isAlive)AudioSystem.startContinuous();});game.lastTime=performance.now();if(!animationFrameId)gameLoop(game.lastTime);console.log("RIPRESA");canvas.focus();}}
        function togglePause(){if(!game.running||game.isGameOver)return;if(game.paused)resumeGame();else pauseGame();}
        function gameOver(victory=false){if(game.isGameOver)return;console.log(`Game Over. Vittoria: ${victory}`);game.isGameOver=true;game.running=false;if(animationFrameId!==null){cancelAnimationFrame(animationFrameId);animationFrameId=null;}if(AudioSystem){if(!victory)AudioSystem.playGameOverSound();AudioSystem.stopContinuous();if(!victory||!game.bossDefeated)AudioSystem.stopAllMP3Music(500);}finalScoreUI.textContent=game.score;gameOverOverlay.style.display='flex';gameOverOverlay.classList.toggle('victory',victory);gameOverOverlay.querySelector('h2').textContent=victory?"VITTORIA!":"FINE PARTITA";const scores=loadHighScores();const lowestScore=scores.length<MAX_HIGH_SCORES?0:scores[scores.length-1].score;if(game.score>lowestScore){console.log("Nuovo High Score!");highScoreEntryUI.style.display='block';playerNameInput.value='';playerNameInput.focus();game.currentScoreSubmitted=false;saveScoreButton.style.display='block';restartButton.style.display='none';const label=highScoreEntryUI.querySelector('label');if(label){if(victory||game.bossDefeated){label.innerHTML='Vittoria Eroica! Nuovo Record! <span title="CMDR Scuderi Sconfitto!">üèÜ</span>';}else{label.textContent='Congratulazioni! Nuovo Record!';}}}else{highScoreEntryUI.style.display='none';restartButton.style.display='block';saveScoreButton.style.display='none';game.currentScoreSubmitted=true;}}
        function loseLife(){if(!spaceship.isAlive)return;console.log("Vita persa!");game.lives--;updateGameUI(game,spaceship);game.explosions.push(new Explosion(spaceship.x+spaceship.width/2,spaceship.y+spaceship.height/2,spaceship.width*1.5,{primary:'#ffaa44',secondary:'#ff8800',accent:'#ffffff',glow:'#ff6600',energy:'#ffff88'},'medium'));if(AudioSystem)AudioSystem.playExplosionSound('medium');spaceship.isAlive=false;if(game.lives<=0){setTimeout(()=>gameOver(false),1000);}else{setTimeout(()=>{if(!game.running||game.isGameOver)return;spaceship.x=canvas.width/2-spaceship.width/2;spaceship.y=canvas.height-spaceship.height-20;spaceship.health=spaceship.maxHealth;spaceship.isAlive=true;spaceship.invincibleAfterLifeLoss=true;spaceship.lifeLossInvincibleTimer=spaceship.LIFE_LOSS_INVINCIBILITY_DURATION;spaceship.invincibleAfterHit=false;spaceship.hitInvincibleTimer=0;spaceship.weaponType=0;spaceship.laserBeamActive=false;if(AudioSystem)AudioSystem.stopContinuous();console.log("Respawn.");updateGameUI(game,spaceship);},2000);}}

        // --- Gestione Onde ---
        function updateWaveSystem(deltaTime){if(game.bossSpawned||game.isGameOver)return;if(game.allWavesCompleted&&!game.inWavePause){if(game.aliens.filter(a=>a.active).length===0){if(!gameBoss&&!game.bossSpawned){console.log("Onde finite, alieni clear. Countdown Boss...");warningBeforeBoss();game.timeUntilNextWave=4000;game.allWavesCompleted=false;game.inWavePause=true;}}return;}if(game.inWavePause){game.timeUntilNextWave-=deltaTime;if(game.timeUntilNextWave<=0){if(game.allWavesCompleted){spawnBoss();game.inWavePause=false;}else{startNextWave();}}}else{const wave=WAVES[game.currentWaveIndex];if(!wave)return;game.waveTimer+=deltaTime;game.alienSpawnTimer-=deltaTime;if(game.waveTimer>=wave.duration&&!game.allWavesCompleted){console.log(`Onda ${game.currentWaveIndex+1} durata terminata.`);game.inWavePause=true;game.timeUntilNextWave=wave.pauseAfter||3000;game.alienSpawnTimer=0;updateGameUI(game,spaceship);return;}if(game.alienSpawnTimer<=0&&game.aliens.filter(a=>a.active).length<wave.maxAliensOnScreen){spawnAlien(wave);game.alienSpawnTimer=wave.spawnInterval*(0.85+Math.random()*0.25);}}}
        function startNextWave(){game.currentWaveIndex++;if(game.currentWaveIndex>=WAVES.length){console.log("Tutte le onde finite! Attesa Boss...");game.allWavesCompleted=true;game.inWavePause=true;game.timeUntilNextWave=5000;warningBeforeBoss();}else{const wave=WAVES[game.currentWaveIndex];console.log(`Avvio Onda ${game.currentWaveIndex+1}: ${wave.name}`);game.waveTimer=0;game.timeUntilNextWave=0;game.inWavePause=false;game.level=game.currentWaveIndex+1;game.alienSpawnTimer=wave.spawnInterval*0.5;}updateGameUI(game,spaceship);}
        function warningBeforeBoss(){console.log("Warning: Boss incoming!");let f=0;const mF=5;const fId=setInterval(()=>{if(f>=mF||game.isGameOver||game.bossSpawned){clearInterval(fId);if(canvas)canvas.style.borderColor="#303050";return;}if(canvas)canvas.style.borderColor=f%2===0?"#ff4444":"#303050";game.screenFlashTimer=SCREEN_FLASH_DURATION;f++;if(f===1){game.uiMessage="‚ö†Ô∏è BOSS IN ARRIVO ‚ö†Ô∏è";game.uiMessageTimer=UI_MESSAGE_DURATION*2.5;if(uiMessageDisplay)uiMessageDisplay.style.color="#ff4444";}},600);}

        // --- Controllo Collisioni ---
        function checkCollisions(deltaTime){const dtS=deltaTime/1000;for(let i=game.playerProjectiles.length-1;i>=0;i--){const p=game.playerProjectiles[i];if(!p.active)continue;for(let j=game.aliens.length-1;j>=0;j--){const a=game.aliens[j];if(!a.active)continue;if(isColliding(p,a)){p.active=false;a.takeDamage(p.damage);break;}}}if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){for(let i=game.playerProjectiles.length-1;i>=0;i--){const p=game.playerProjectiles[i];if(!p.active)continue;const bR={x:gameBoss.x-gameBoss.width/2,y:gameBoss.y-gameBoss.height/2,width:gameBoss.width,height:gameBoss.height};if(isColliding(p,bR)){gameBoss.takeDamage(p.damage,p.x+p.width/2,p.y+p.height/2);p.active=false;}}}if(spaceship.laserBeamActive&&spaceship.isAlive&&isSpaceshipCurrentlyVisible()){const lW=12;const lR={x:spaceship.x+spaceship.width/2-lW/2,y:0,width:lW,height:spaceship.y};game.aliens.forEach(a=>{if(a.active&&isColliding(lR,{x:a.x-a.collisionRadius,y:a.y-a.collisionRadius,width:a.collisionRadius*2,height:a.collisionRadius*2})){a.takeDamage(LASER_DPS*dtS);if(game.animationFrame%5===0)a.hitEffects.push({x:(Math.random()-.5)*a.size*.3,y:(Math.random()-.5)*a.size*.3,size:a.size*.2,life:0.5});}});if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){for(const k in gameBoss.components){const c=gameBoss.components[k];if(!c.active||!c.isHittable)continue;const cR={x:gameBoss.x+c.x-c.width/2,y:gameBoss.y+c.y-c.height/2,width:c.width,height:c.height};if(isColliding(lR,cR)){const hX=spaceship.x+spaceship.width/2;const hY=Math.max(cR.y,lR.y);gameBoss.takeDamage(LASER_DPS*dtS,hX,hY);}}}}if(spaceship.isAlive&&!spaceship.shieldActive&&!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss){for(let i=game.alienProjectiles.length-1;i>=0;i--){const ap=game.alienProjectiles[i];if(ap.active&&ap.lifeTimer===null&&isColliding(ap,spaceship)){ap.active=false;spaceship.takeDamage(ap.damage);}}}else if(spaceship.isAlive&&spaceship.shieldActive){const sR=spaceship.width*0.8;const sCX=spaceship.x+spaceship.width/2;const sCY=spaceship.y+spaceship.height/2;for(let i=game.alienProjectiles.length-1;i>=0;i--){const ap=game.alienProjectiles[i];if(!ap.active)continue;const dx=ap.x+ap.width/2-sCX;const dy=ap.y+ap.height/2-sCY;const dSq=dx*dx+dy*dy;if(dSq<(sR+ap.width/2)**2){ap.active=false;game.explosions.push(new Explosion(ap.x,ap.y,15,{primary:"#fff",energy:"#80ffff"},'small'));}}}}

        // --- Game Loop Principale ---
        function gameLoop(currentTime){if(!ctx||!canvas||!game||!spaceship){console.error("ERRORE CRITICO: Oggetti essenziali mancanti nel game loop. Interruzione.");if(animationFrameId){cancelAnimationFrame(animationFrameId);animationFrameId=null;}return;}try{if(!game.running){if(animationFrameId)cancelAnimationFrame(animationFrameId);animationFrameId=null;return;}if(game.paused){animationFrameId=requestAnimationFrame(gameLoop);return;}if(!game.lastTime)game.lastTime=currentTime;game.deltaTime=currentTime-game.lastTime;game.lastTime=currentTime;if(game.deltaTime>100)game.deltaTime=16.67;game.animationFrame++;if(game.globalAlienFireCooldown>0)game.globalAlienFireCooldown-=game.deltaTime;if(game.screenFlashTimer>0)game.screenFlashTimer-=game.deltaTime;updateUIState(game.deltaTime);updateStars(game.stars,starSpeed,canvas.height,game.deltaTime);updatePlanets(game.planets,game.deltaTime);updateSpaceship(game.deltaTime);updateProjectiles(game.playerProjectiles,game.deltaTime);updateAliens(game.deltaTime);updateProjectiles(game.alienProjectiles,game.deltaTime);updatePowerUps(game.deltaTime);updateCrystals(game.deltaTime);updateExplosions(game.deltaTime);updateBoss(gameBoss,game.deltaTime);updateWaveSystem(game.deltaTime);checkCollisions(game.deltaTime);ctx.clearRect(0,0,canvas.width,canvas.height);drawBackground();drawCrystals(ctx);drawPowerUps();drawAliens();drawProjectiles(game.alienProjectiles);drawSpaceship();drawLaserBeam();drawProjectiles(game.playerProjectiles);if(gameBoss&&gameBoss.isVisible)gameBoss.draw(ctx);drawExplosions();drawUIEffects();drawBossHealth();updateGameUI(game,spaceship);animationFrameId=requestAnimationFrame(gameLoop);}catch(error){console.error("ERRORE FATALE nel game loop:",error);game.running=false;if(ctx&&canvas){try{ctx.fillStyle="rgba(0,0,0,0.85)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#ff4444";ctx.font="bold 22px VT323";ctx.textAlign="center";ctx.fillText("ERRORE DI SISTEMA!",canvas.width/2,canvas.height/2-20);ctx.font="16px VT323";ctx.fillStyle="#ffaaaa";ctx.fillText("Si √® verificato un errore critico.",canvas.width/2,canvas.height/2+10);ctx.fillText("Ricarica la pagina (F5) o consulta la console (F12).",canvas.width/2,canvas.height/2+35);}catch(e2){console.error("Errore nel disegnare il messaggio di errore:",e2);}}if(animationFrameId){cancelAnimationFrame(animationFrameId);animationFrameId=null;}}}

        // --- Funzioni Intro e Flusso Iniziale ---
        function startIntroSequence() {console.log("Starting Intro...");if(!introOverlay||!mainLayout||!skipIntroButton||!introLogoCanvas){console.error("Intro elements missing.");return;}window.introOver=false;window.introAudioPlayed=false;introOverlay.style.opacity='1';introOverlay.classList.remove('hidden');introOverlay.style.display='flex';drawCondorspaceTitleLogo(introLogoCanvas);mainLayout.classList.remove('visible');if(startButton)startButton.style.display="none";if(gameOverOverlay)gameOverOverlay.style.display="none";skipIntroButton.removeEventListener('click',handleSkipInteraction);window.removeEventListener('keydown',handleIntroSkipKey);skipIntroButton.addEventListener('click',handleSkipInteraction);window.addEventListener('keydown',handleIntroSkipKey);const introDuration=60000;if(window.introTimeout)clearTimeout(window.introTimeout);window.introTimeout=setTimeout(()=>{if(!window.introOver)handleSkipInteraction();},introDuration);if(AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){console.log("Playing intro music immediately.");AudioSystem.playIntroMP3();window.introAudioPlayed=true;}else{console.log("Audio context suspended, intro music will wait.");}const crawlC=document.getElementById('crawlContainer');if(crawlC)setTimeout(()=>{crawlC.style.opacity='1';},5000);}
        function handleSkipInteraction() {if(window.introOver)return;console.log("Intro interaction.");AudioSystem.playButtonSound();AudioSystem.resumeContext(()=>{if(!window.introAudioPlayed&&AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){console.log("Audio context running after interaction, playing intro music.");AudioSystem.playIntroMP3();window.introAudioPlayed=true;}skipIntroVisuals();});}
        function skipIntroVisuals() {if(window.introOver)return;window.introOver=true;console.log("Ending Intro Visuals...");if(window.introTimeout)clearTimeout(window.introTimeout);window.introTimeout=null;const skipBtn=document.getElementById('skipIntroButton');if(skipBtn)skipBtn.removeEventListener('click',handleSkipInteraction);window.removeEventListener('keydown',handleIntroSkipKey);if(introOverlay){introOverlay.style.opacity='0';introOverlay.classList.add('hidden');}setTimeout(()=>{if(introOverlay)introOverlay.style.display='none';showCadetRegistration();},1000);}
        function handleIntroSkipKey(e) {const pNI=document.getElementById('playerNameInput');if(e.key===" "&&!window.introOver&&(!pNI||document.activeElement!==pNI)){e.preventDefault();handleSkipInteraction();}}

        // --- Funzioni Registrazione Cadetto (Implementazione da te fornita) ---
        function showCadetRegistration(){console.log("Mostra registrazione cadetto...");const screen=document.getElementById('cadetRegistrationScreen');if(screen){screen.classList.add('active');if(typeof renderCadetRegistration==='function')renderCadetRegistration();else{console.error("renderCadetRegistration non definita");completeCadetRegistration("CADETTO");}}else{console.error("Schermata registrazione non trovata!");completeCadetRegistration("CADETTO");}}
        function completeCadetRegistration(cadetName){const screen=document.getElementById('cadetRegistrationScreen');const layout=document.getElementById('mainLayout');const btn=document.getElementById('startButton');if(screen)screen.classList.remove('active');if(layout)layout.classList.add('visible');if(btn){btn.style.display='block';btn.disabled=false;btn.focus();}console.log("Registrazione completata:",cadetName);if(window.game)game.cadetName=cadetName;updateCadetNameInUI(cadetName);const sub=document.querySelector('#titleHeader h2');if(sub)sub.textContent="NETHEX CONTRO IL DEMAND GALATTICO";}
        function updateCadetNameInUI(cadetName){const sidebar=document.getElementById('uiSidebar');if(!sidebar)return;let container=document.getElementById('cadetNameContainer');if(!container){container=document.createElement('div');container.id='cadetNameContainer';container.style.marginTop='15px';container.style.marginBottom='15px';container.style.textAlign='center';container.style.padding='8px 0';container.style.borderTop='1px solid #445566';container.style.borderBottom='1px solid #445566';container.style.backgroundColor='rgba(0,0,0,0.15)';container.innerHTML=`<div style="color:#aaccff;font-size:0.9em;margin-bottom:3px;text-transform:uppercase;letter-spacing:1px;">PILOTA</div><div id="cadetNameDisplay" style="color:#ffaa44;font-weight:bold;font-size:1.1em;text-shadow:0 0 4px #ffaa44;">${cadetName}</div><div style="color:#aaccff;font-size:0.8em;margin-top:3px;font-style:italic;">STATO MISSIONE</div>`;const header=sidebar.querySelector('h3');if(header)header.after(container);else sidebar.prepend(container);}else{const display=document.getElementById('cadetNameDisplay');if(display)display.textContent=cadetName;}}
        function renderCadetRegistration(){console.log("Rendering cadet registration UI...");const container=document.getElementById('cadetRegistrationContainer');if(!container){console.error("Container registrazione cadetto non trovato");return;}let cadetName='';let isSubmitting=false;container.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;background:#0f0f1e;padding:20px;border-radius:10px;border:1px solid #49daff;box-shadow:0 0 30px rgba(73,218,255,0.4);"><canvas id="cadetCanvas" width="500" height="300" style="margin-bottom:20px;border-radius:5px;"></canvas><div style="display:flex;align-items:center;width:80%;margin-bottom:20px;"><input type="text" id="cadetNameInputReg" placeholder="Inserisci il tuo nome, Cadetto" style="flex:1;padding:10px;background:#0a0a2a;color:#49daff;border:2px solid #49daff;border-radius:4px;font-size:16px;font-family:'VT323',monospace;" maxlength="10" minlength="3"><button id="submitCadetButton" style="margin-left:10px;padding:10px 20px;background:#49daff;color:#000;border:none;border-radius:4px;font-weight:normal;cursor:pointer;font-family:'VT323',monospace;text-transform:uppercase;letter-spacing:1px;" disabled>CONFERMA</button></div><p style="color:#bbb;font-size:14px;text-align:center;line-height:1.4;">Identificati, pilota.<br>Il tuo nome verr√† inciso negli annali del Demand.</p></div>`;drawCadetRegistrationCanvas();const inputField=document.getElementById('cadetNameInputReg');const confirmButton=document.getElementById('submitCadetButton');if(!inputField||!confirmButton){console.error("Elementi UI registrazione mancanti");return;}const updateSubmitState=()=>{if(isSubmitting){confirmButton.disabled=true;confirmButton.textContent='REGISTRAZIONE...';confirmButton.style.background='#274b5d';confirmButton.style.color='#aaa';confirmButton.style.cursor='wait';}else if(cadetName.length<3){confirmButton.disabled=true;confirmButton.textContent='CONFERMA';confirmButton.style.background='#274b5d';confirmButton.style.color='#aaa';confirmButton.style.cursor='not-allowed';}else{confirmButton.disabled=false;confirmButton.textContent='CONFERMA';confirmButton.style.background='#49daff';confirmButton.style.color='#000';confirmButton.style.cursor='pointer';}};const handleCadetSubmit=()=>{if(cadetName.length<3||isSubmitting)return;console.log("Invio registrazione:",cadetName);isSubmitting=true;updateSubmitState();AudioSystem.playButtonSound();AudioSystem.play('gameStart');setTimeout(()=>{isSubmitting=false;updateSubmitState();completeCadetRegistration(cadetName);},1000);};inputField.addEventListener('input',(e)=>{cadetName=e.target.value.trim().toUpperCase();e.target.value=cadetName;updateSubmitState();});inputField.addEventListener('keyup',(e)=>{if(e.key==='Enter'&&!isSubmitting&&cadetName.length>=3)handleCadetSubmit();});confirmButton.addEventListener('click',handleCadetSubmit);updateSubmitState();setTimeout(()=>{if(inputField)inputField.focus();},100);}
        function drawCadetRegistrationCanvas(){const canvasReg=document.getElementById('cadetCanvas');if(!canvasReg)return;const ctxReg=canvasReg.getContext('2d');if(!ctxReg)return;const w=canvasReg.width;const h=canvasReg.height;const bgG=ctxReg.createLinearGradient(0,0,0,h);bgG.addColorStop(0,'#0c1445');bgG.addColorStop(1,'#0a0a20');ctxReg.fillStyle=bgG;ctxReg.fillRect(0,0,w,h);for(let i=0;i<150;i++){const x=Math.random()*w;const y=Math.random()*h;const r=Math.random()*1.5;const o=Math.random()*0.8+0.2;ctxReg.beginPath();ctxReg.arc(x,y,r,0,Math.PI*2);ctxReg.fillStyle=`rgba(255,255,255,${o})`;ctxReg.fill();}ctxReg.strokeStyle='#49daff';ctxReg.lineWidth=3;ctxReg.shadowColor='#49daff';ctxReg.shadowBlur=10;ctxReg.strokeRect(20,20,w-40,h-40);ctxReg.shadowBlur=0;ctxReg.lineWidth=5;const cs=20;ctxReg.beginPath();ctxReg.moveTo(20,40);ctxReg.lineTo(20,20);ctxReg.lineTo(40,20);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(w-40,20);ctxReg.lineTo(w-20,20);ctxReg.lineTo(w-20,40);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(20,h-40);ctxReg.lineTo(20,h-20);ctxReg.lineTo(40,h-20);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(w-40,h-20);ctxReg.lineTo(w-20,h-20);ctxReg.lineTo(w-20,h-40);ctxReg.stroke();ctxReg.shadowColor='#49daff';ctxReg.shadowBlur=5;ctxReg.font='bold 24px VT323';ctxReg.fillStyle='#49daff';ctxReg.textAlign='center';ctxReg.fillText('REGISTRAZIONE NUOVA RECLUTA',w/2,60);ctxReg.shadowBlur=0;drawCondorspaceTitleLogo({getContext:()=>ctxReg,width:150,height:75,getBoundingClientRect:()=>({width:150,height:75})});} // Usa la funzione logo corretta
        function initCrystalSystem(){console.log("Inizializzazione cristalli...");if(!game.crystals)game.crystals=[];const origTakeDamage=Alien.prototype.takeDamage;if(origTakeDamage&&!origTakeDamage.isPatchedForCrystals){Alien.prototype.takeDamage=function(amount){const destroyed=origTakeDamage.call(this,amount);if(destroyed&&typeof spawnCrystalsFromAlien==='function')spawnCrystalsFromAlien(this);return destroyed;};Alien.prototype.takeDamage.isPatchedForCrystals=true;}console.log("Sistema cristalli pronto.");}


        // --- Setup Iniziale e Listener DOMContentLoaded ---
        function initialize() {
             console.log("INFO: Initializing CONDORSPACE V2.11.5...");
             if (!assignElements()) { console.error("FATAL: Initialization failed: DOM elements missing."); return; }
             AudioSystem.init(() => {
                 console.log("INFO: Audio system initialized (state: " + AudioSystem.context?.state + ").");
                 displayHighScores();
                 if(titleLogoCanvas) drawCondorspaceTitleLogo(titleLogoCanvas);
                 setupButtonListeners();
                 // Spostato initCrystalSystem, createStars, createInitialPlanets, drawBackground
                 // all'interno del click del pulsante "AVVIA SISTEMA" per assicurare che il DOM sia pronto E l'audio attivo
                 console.log("INFO: Core initialization complete. Waiting for user interaction to start intro.");
                 const systemStartButton = document.createElement('button');
                 systemStartButton.id = 'systemStartButton'; systemStartButton.textContent = 'AVVIA SISTEMA';
                 systemStartButton.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px 40px;font-size:2em;font-family:'VT323',monospace;background:transparent;color:#49daff;border:2px solid #49daff;cursor:pointer;z-index:10000;";
                 systemStartButton.onmouseover = ()=>{systemStartButton.style.backgroundColor='rgba(73,218,255,0.1)';systemStartButton.style.boxShadow='0 0 15px #49daff';};
                 systemStartButton.onmouseout = ()=>{systemStartButton.style.backgroundColor='transparent';systemStartButton.style.boxShadow='none';};
                 systemStartButton.onclick = () => {
                     AudioSystem.playButtonSound();
                     AudioSystem.resumeContext(() => {
                          if(systemStartButton) systemStartButton.remove();
                          // Ora inizializza le parti grafiche che dipendono dal canvas
                          initCrystalSystem();
                          createStars();
                          createInitialPlanets();
                          if(ctx && canvas) drawBackground();
                          startIntroSequence();
                     });
                 };
                 document.body.appendChild(systemStartButton);
             });
             addGameEventListeners();
        }
        function setupButtonListeners() {
             if(startButton){startButton.onclick=()=>{if(startButton.disabled)return;startButton.disabled=true;startButton.textContent="Avvio...";AudioSystem.playButtonSound();AudioSystem.resumeContext(()=>{startGame();});};}
             if(restartButton){restartButton.onclick=()=>{if(!gameOverOverlay||gameOverOverlay.style.display==='none')return;AudioSystem.playButtonSound();gameOverOverlay.style.display="none";if(mainLayout)mainLayout.classList.add('visible');if(ctx&&canvas){ctx.fillStyle="#050510";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#aaccff";ctx.textAlign="center";ctx.font="20px VT323";ctx.fillText("Riavvio...",canvas.width/2,canvas.height/2);ctx.textAlign="left";}startGame(true);};}
             if(saveScoreButton){saveScoreButton.onclick=()=>{AudioSystem.playButtonSound();submitHighScore();};}
             if(playerNameInput){playerNameInput.onkeyup=(e)=>{if(e.key==="Enter")submitHighScore();};}
        }
        function addGameEventListeners() { window.addEventListener('keydown',handleKeyDown);window.addEventListener('keyup',handleKeyUp);window.addEventListener('keydown',function(e){if(e.key===" "&&document.activeElement!==playerNameInput&&(!game.running||game.paused)&&!window.introOver)e.preventDefault();});window.addEventListener('blur',()=>{if(game.running&&!game.paused&&!game.isGameOver)pauseGame();});window.addEventListener('error',e=>{console.error("Unhandled error:",e.message,e.filename,e.lineno);if(!game.errorNotified)game.errorNotified=true;}); }

        // --- Avvio Inizializzazione ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
    <!-- === FINE BLOCCO 6 === -->
    <!-- === INSERISCI QUI IL BLOCCO 7 (HTML Closing Tags) === -->
      
<!-- === INIZIO BLOCCO 7 (HTML Closing Tags) === -->
</body>
</html>
    <!-- === FINE BLOCCO 7 === -->
    <!-- === FINE DEL FILE === -->

    