<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CONDORSPACE V2.12.2 - Ricostruzione Stabile</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">

    <!-- === FINE BLOCCO 1 === -->
    <!-- === INSERISCI QUI IL BLOCCO 2 (CSS Styles) === -->
    <!-- === INIZIO BLOCCO 2 (CSS Styles) === -->
    <style>
        /* Base Styles */
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #050510; font-family: 'VT323', monospace; color: #e0e0ff; overflow: hidden; }
        canvas { image-rendering: pixelated; /* Mantiene nitidezza pixel art */ }

        /* Pulsante Iniziale "START" */
        #systemStartButton { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; font-size: 2.5em; font-family: 'VT323', monospace; background: transparent; color: #49daff; border: 3px solid #49daff; cursor: pointer; z-index: 30000; transition: background-color 0.3s, box-shadow 0.3s, color 0.3s; letter-spacing: 2px; }
        #systemStartButton:hover { background-color: rgba(73, 218, 255, 0.15); box-shadow: 0 0 20px #49daff, inset 0 0 10px rgba(73, 218, 255, 0.5); color: #fff; }

        /* Splash Screen Logo Parallax */
        #parallaxLogoSplashContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 20000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s ease-out; }
        #parallaxLogoSplashContainer.visible { display: flex; opacity: 1; }
        #parallaxLogoSplash { width: 250px; height: 250px; background-image: url('assets/images/logo.png'); background-size: contain; background-repeat: no-repeat; background-position: center; animation: gentlePulse 3s ease-in-out infinite alternate; }
        @keyframes gentlePulse { from { transform: scale(0.95); } to { transform: scale(1.05); } }

        /* Layout Principale Gioco */
        #mainLayout { display: none; align-items: flex-start; background-color: #0c0c18; border-radius: 8px; box-shadow: 0 0 25px rgba(0, 180, 255, 0.2); padding: 10px; opacity: 0; transition: opacity 0.5s ease-in; position: relative; z-index: 1; pointer-events: none; }
        #mainLayout.visible { display: flex; opacity: 1; pointer-events: auto; }

        /* High Score Container & Title Header (Sidebar Sinistra) */
        #highScoreContainer { width: 180px; height: 640px; padding: 0; margin-right: 15px; background-color: rgba(26, 26, 42, 0.8); border: 1px solid #333; border-radius: 5px; box-shadow: inset 0 0 8px rgba(0,0,0,0.6); display: flex; flex-direction: column; color: #c0c0dd; }
        #titleHeader { padding: 10px 15px 5px 15px; text-align: center; border-bottom: 1px solid #445566; background-color: rgba(0,0,0,0.2); flex-shrink: 0; }
        #titleHeader canvas#titleLogoCanvas { margin-bottom: 5px; width: 80%; height: auto; max-width: 100px; display: block; margin-left: auto; margin-right: auto; }
        #titleHeader h1 { font-size: 1.3em; margin: 5px 0 2px 0; color: #49daff; text-shadow: 0 0 8px #49daff; letter-spacing: 2px; text-transform: uppercase; }
        #titleHeader h2 { font-size: 0.8em; margin: 0 0 8px 0; color: #a0e0ff; font-weight: normal; letter-spacing: 1px; }
        #highScoreContent { padding: 10px 15px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #highScoreContent h3 { margin-top: 5px; margin-bottom: 15px; color: #aaccff; text-align: center; border-bottom: 1px solid #445566; padding-bottom: 8px; font-size: 1.1em; letter-spacing: 1px; }
        #highScoreList { list-style:none; padding:0; margin:0 0 20px 0; font-size:14px; flex-grow:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:#445566 #0c0c18;}
        #highScoreList::-webkit-scrollbar { width: 6px; }
        #highScoreList::-webkit-scrollbar-track { background: #0c0c18; }
        #highScoreList::-webkit-scrollbar-thumb { background-color: #445566; border-radius: 3px; }
        #highScoreList li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding: 3px 5px; border-radius: 3px; background-color: rgba(0,0,0,0.1); border-left: 3px solid transparent; transition: background-color 0.3s, border-left 0.3s; }
        #highScoreList li:hover { background-color: rgba(255,255,255,0.15); border-left-color: #49daff; }
        #highScoreList li span:first-child { font-weight: normal; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; line-height: 1.2; }
        #highScoreList li span:first-child span { font-size: 0.9em; vertical-align: middle; margin-left: 4px; }
        #highScoreList li span:nth-child(2) { color: #ffff88; min-width: 40px; text-align: right; font-weight: bold; }
        .instructions { margin-top: auto; padding: 15px 0 5px 0; border-top: 1px solid #445566; font-size: 13px; color: #bbddff; text-align: left; text-shadow: 0 0 4px rgba(100,180,255,0.8); flex-shrink: 0; line-height: 1.4; }

        #canvasWrapper { position: relative; width: 480px; height: 640px; overflow: hidden; margin: 0; padding: 0; }
        #gameCanvas { border: 1px solid #303050; box-shadow: 0 0 15px rgba(0,150,255,0.3); display: block; background-color: #0a0a1a; width: 100%; height: 100%; cursor: default; transition: border-color 0.3s ease; }
        #gameCanvas:focus { outline: none; border-color: #49daff; }
        #uiSidebar { width: 180px; padding: 10px 15px; margin-left: 15px; background-color: rgba(26,26,42,0.8); border: 1px solid #333; border-radius: 5px; box-shadow: inset 0 0 8px rgba(0,0,0,0.6); height: 640px; display: flex; flex-direction: column; }
        #uiSidebar h3 { margin-top: 5px; margin-bottom: 15px; color: #aaccff; text-align: center; border-bottom: 1px solid #445566; padding-bottom: 8px; font-size: 1.1em; letter-spacing: 1px; }
        #uiSidebar p { margin: 8px 0; font-size: 15px; color: #c0c0dd; display: flex; justify-content: space-between; align-items: center; }
        #uiSidebar span { font-weight: normal; color: #fff; background-color: rgba(0,0,0,0.2); padding: 1px 4px; border-radius: 3px; min-width: 40px; text-align: right; }
        .shieldActiveUI { color: #80ffff !important; font-weight: bold; text-shadow: 0 0 5px #80ffff; }
        #healthBarContainer { width:100%; height:10px; background-color:rgba(255,0,0,0.3); border:1px solid #800; border-radius:2px; margin-top:2px; overflow:hidden; }
        #healthBar { height:100%; width:100%; background-color:#40ff40; border-radius:1px; transition:width 0.2s ease-out, background-color 0.2s ease; }
        #healthValue { font-size:0.9em; margin-left:5px; font-weight:bold; }
        #cadetNameContainer { margin-top:15px; margin-bottom:15px; text-align:center; padding:8px 0; border-top:1px solid #445566; border-bottom:1px solid #445566; background-color:rgba(0,0,0,0.15); }
        #cadetNameContainer div:first-child { color:#aaccff; font-size:0.9em; margin-bottom:3px; text-transform:uppercase; letter-spacing:1px; }
        #cadetNameDisplay { color:#ffaa44; font-weight:bold; font-size:1.1em; text-shadow:0 0 4px #ffaa44; }
        #cadetNameContainer div:last-child { color:#aaccff; font-size:0.8em; margin-top:3px; font-style:italic; }

        #bossHealthBarContainer { position:absolute; top:10px; left:10%; width:80%; height:18px; background-color:rgba(100,0,0,0.7); border:2px solid #ff8888; border-radius:4px; z-index:60; display:none; overflow:hidden; box-shadow:0 0 10px rgba(255,0,0,0.5); }
        #bossHealthBar { height:100%; width:100%; background:linear-gradient(to right, #ff4444, #ff8888); border-radius:2px; transition:width 0.3s ease-out; }
        #bossHealthText { position:absolute; top:0; left:0; width:100%; text-align:center; font-size:12px; font-weight:bold; color:#fff; line-height:18px; text-shadow:1px 1px 2px black; letter-spacing:1px; }

        .overlayButton { padding:12px 25px; font-size:1.1em; cursor:pointer; color:#fff; border-radius:5px; text-shadow:0 1px 3px rgba(0,0,0,0.5); transition:all .2s ease; margin-top:10px; text-transform:uppercase; letter-spacing:1px; }
        #startButton { display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background-color:#2a9fd8; border:2px solid #1c6d9a; box-shadow:0 0 15px rgba(40,160,220,0.7); z-index:20; }
        #startButton:hover:not(:disabled) { background-color:#3ab0e8; box-shadow:0 0 20px rgba(60,180,240,0.9); transform:translate(-50%,-50%) scale(1.05); }
        #startButton:disabled { background-color:#555; border-color:#444; cursor:wait; opacity:0.7; }
        #gameOverOverlay { display:none; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:380px; padding:25px; background-color:rgba(10,10,30,0.95); border:2px solid #667799; border-radius:10px; text-align:center; box-shadow:0 0 25px rgba(100,120,180,0.5); z-index:30; flex-direction:column; align-items:center; transition:border-color .5s ease,box-shadow .5s ease; }
        #gameOverOverlay.victory { border-color:#ffd700; box-shadow:0 0 25px rgba(255,215,0,0.6); }
        #gameOverOverlay h2 { margin-top:0; margin-bottom:15px; font-size:2.3em; letter-spacing:2px; }
        #gameOverOverlay:not(.victory) h2 { color:#ff6666; text-shadow:0 0 10px rgba(255,50,50,0.7); }
        #gameOverOverlay.victory h2 { color:#ffd700; text-shadow:0 0 10px rgba(255,215,0,0.8); }
        #gameOverOverlay p { font-size:1.1em; color:#ddddff; margin-bottom:15px; }
        #finalScore { font-weight:bold; color:#ffff88; font-size:1.2em; }
        #finalScore span { display:inline-block; margin-left:5px; }
        #highScoreEntry { display:none; width:85%; margin-top:15px; }
        #highScoreEntry label { display:block; margin-bottom:5px; font-size:1em; color:#aaccff; }
        #highScoreEntry label span { display:inline-block; margin-left:5px; }
        #playerNameInput { width:calc(100% - 22px); padding:9px 10px; font-size:1em; border:1px solid #667799; background-color:#1a1a3a; color:#e0e0ff; border-radius:4px; text-align:center; margin-top:5px; font-family:'VT323',monospace; }
        #saveScoreButton { background-color:#f0ad4e; border:2px solid #eea236; box-shadow:0 0 15px rgba(240,173,78,0.6); }
        #saveScoreButton:hover { background-color:#f3bd72; box-shadow:0 0 20px rgba(240,173,78,0.8); transform:scale(1.05); }
        #restartButton { background-color:#5cb85c; border:2px solid #4cae4c; box-shadow:0 0 15px rgba(92,184,92,0.6); }
        #restartButton:hover { background-color:#6cd96c; box-shadow:0 0 20px rgba(110,200,110,0.8); transform:scale(1.05); }
        #pauseOverlay { position:absolute; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,20,0.7); z-index:40; display:none; justify-content:center; align-items:center; text-align:center; font-size:2.5em; color:#aaccff; text-shadow:0 0 10px #00ffff; pointer-events:none; letter-spacing:3px; }
        #pauseOverlay.visible { display:flex; }
        #uiMessageDisplay { position:absolute; top:40%; left:50%; transform:translateX(-50%); background-color:rgba(0,0,0,0.75); color:#ff6666; padding:10px 20px; border-radius:5px; font-size:1.3em; font-weight:normal; z-index:50; text-align:center; text-shadow:1px 1px 2px black; opacity:0; transition:opacity .3s ease-out; pointer-events:none; }
        #uiMessageDisplay.visible { opacity:1; }

        /* Stili Intro Terminale */
        #introOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background-color:#000; z-index:1000; display:none; justify-content:center; align-items:center; overflow:hidden; perspective:400px; font-family:'VT323',monospace; opacity:0; transition:opacity 1s ease-out; }
        #introOverlay.visible { display:flex; opacity:1; }
        #introOverlay.hidden { opacity:0; pointer-events:none; }
        #introSequence { position:relative; width:100%; height:100%; }
        #introLogoContainer { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); text-align:center; color:#49daff; opacity:0; animation:fadeInLogo 5s ease-out forwards; z-index:1002; }
        #introLogoCanvas { display:block; margin:0 auto 10px auto; width:150px; height:75px; image-rendering:pixelated; }
        #introGameTitle { font-size:3.5em; margin:0; text-shadow:0 0 15px #49daff,0 0 5px #fff; letter-spacing:4px; text-transform:uppercase; }
        #introGameSubtitle { font-size:1.2em; margin:5px 0 0 0; color:#a0e0ff; text-shadow:0 0 5px #a0e0ff; letter-spacing:2px; text-transform:uppercase; }
        @keyframes fadeInLogo{0%{opacity:0;transform:translate(-50%,-50%) scale(.8)}20%{opacity:1;transform:translate(-50%,-50%) scale(1)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.2)}}
        #crawlContainer { position:absolute; bottom:0; height:200%; width:90%; max-width:800px; left:50%; transform-origin:50% 100%; transform:translateX(-50%) rotateX(25deg); animation:crawl 60s linear 5s forwards; opacity:0; z-index:1001; }
        #crawlContent { color:#a0e0ff; font-size:1.8em; line-height:1.45em; text-align:left; text-shadow:0 0 8px #49daff; letter-spacing:.5px; }
        #crawlContent .subtitle { font-size:1.2em; text-align:center; margin-bottom:1.5em; color:#fff; text-shadow:0 0 10px #a0e0ff; }
        #crawlContent p { margin-bottom:1.2em; position:relative; padding-left:30px; }
        #crawlContent p:before { content:">"; position:absolute; left:0; color:#49daff; }
        @keyframes crawl{0%{bottom:-100%;opacity:1}100%{bottom:110%;opacity:1}}
        #skipIntroButton { position:absolute; bottom:20px; right:20px; padding:10px 20px; font-size:14px; background-color:rgba(0,0,0,0.7); color:#49daff; border:1px solid #49daff; border-radius:5px; cursor:pointer; z-index:1003; opacity:.7; transition:opacity .3s, background-color .3s; }
        #skipIntroButton:hover { opacity:1; background-color:rgba(255,255,255,0.2); color:#eee; }

        .crt-effect{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,.25) 50%),linear-gradient(90deg,rgba(255,0,0,.06),rgba(0,255,0,.02),rgba(0,0,255,.06));background-size:100% 2px,3px 100%;pointer-events:none;z-index:1004}
        #terminal-header,#terminal-footer{position:absolute;left:10px;font-size:1em;color:#49daff;text-shadow:0 0 5px #49daff;padding:5px;z-index:1002;text-align:left;opacity:0;animation:fadeIn 2s ease-in forwards 2s;max-width:50%}
        #terminal-header{top:10px}#terminal-footer{bottom:10px}
        @keyframes textShadowFlicker{0%,20%,50%,70%,100%{text-shadow:0 0 5px rgba(73,218,255,.5)}10%,60%,90%{text-shadow:0 0 7px rgba(73,218,255,.7)}30%{text-shadow:0 0 8px rgba(73,218,255,.8)}40%,80%{text-shadow:0 0 6px rgba(73,218,255,.6)}}
        .flicker-text{animation:textShadowFlicker 5s infinite}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}
        .cursor{display:inline-block;width:10px;height:20px;background-color:#49daff;margin-left:5px;animation:blink 1s infinite;vertical-align:middle}

        /* Schermata Registrazione Cadetto */
        #cadetRegistrationScreen{position:fixed;top:0;left:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.95);z-index:900;opacity:0;transition:opacity .5s ease-in-out;pointer-events:none}
        #cadetRegistrationScreen.active{display:flex;opacity:1;pointer-events:auto}
        #cadetRegistrationContainer{background:transparent;padding:0;border:none;box-shadow:none;width:auto}
        #cadetRegistrationContainer > div{display:flex;flex-direction:column;align-items:center;background:#0f0f1e;padding:20px;border-radius:10px;border:1px solid #49daff;box-shadow:0 0 30px rgba(73,218,255,.4); width: 500px; /* Larghezza fissa per coerenza */ }
        #cadetCanvas{margin-bottom:20px;max-width:100%;height:auto;border-radius:5px; background-color: #080818; /* Sfondo leggermente diverso per il canvas interno */ }
        #cadetNameInputReg{flex:1;padding:10px;background:#0a0a2a;color:#49daff;border:2px solid #49daff;border-radius:4px;font-size:16px;font-family:'VT323',monospace;width: 80%; /* Larghezza input */}
        #submitCadetButton{margin-left:10px;padding:10px 20px;background:#49daff;color:#000;border:none;border-radius:4px;font-weight:normal;cursor:pointer;font-family:'VT323',monospace;text-transform:uppercase;letter-spacing:1px}
        #submitCadetButton:hover:not(:disabled){background-color:#a0e0ff;box-shadow:0 0 15px #49daff}
        #submitCadetButton:disabled{background:#274b5d;color:#aaa;cursor:not-allowed;opacity:.7}
    </style>
</head>
<body> <!-- Tag body aperto -->

    <!-- === FINE BLOCCO 2 === -->
    <!-- === INSERISCI QUI IL BLOCCO 3 (HTML Body Content) === -->
    <!-- === INIZIO BLOCCO 3 (HTML Body Content) === -->

    <!-- Pulsante Iniziale per Attivare Audio e Sequenza -->
    <button id="systemStartButton">START</button> <!-- Testo cambiato -->

    <!-- Schermata Splash Logo Parallax -->
    <div id="parallaxLogoSplashContainer">
        <div id="parallaxLogoSplash"></div>
    </div>

    <!-- Overlay Intro Terminale -->
    <div id="introOverlay">
        <div id="terminal-header" class="flicker-text">
            DEMAND GALATTICO DEFCOM v3.7.2<br>
            RAM: 16384Kb ONLINE<br>
            RAPTOR-X MISSION BRIEFING
        </div>
        <div id="terminal-footer" class="flicker-text">
            ENCRYPTION: ENABLED<br>
            CMDR CONDOR AUTH: OK
        </div>
        <div id="introSequence">
            <div id="introLogoContainer">
                <canvas id="introLogoCanvas" width="150" height="75"></canvas>
                <h1 id="introGameTitle" class="flicker-text">CONDORSPACE</h1>
                <h2 id="introGameSubtitle" class="flicker-text">NETHEX CONTRO IL DEMAND GALATTICO</h2>
            </div>
            <div id="crawlContainer">
                <div id="crawlContent">
                    <div class="subtitle flicker-text">LA MINACCIA DELL'IMPERATRICE CIVELLO</div>
                    <p>INIT BRIEFING SEQUENCE...</p>
                    <p>È un'era di prosperità per l'umanità. Grazie al Demand Galattico, una vasta rete di cooperazione interplanetaria, le colonie terrestri fioriscono tra le stelle.</p>
                    <p>WARNING: ENEMY INTEL DETECTED</p>
                    <p>Sul pianeta Nethex, la sanguinaria Imperatrice Civello governa con pugno di ferro. Il suo unico scopo è vedere distrutto il Demand Galattico e l'intera civiltà terrestre.</p>
                    <p>Per compiere la sua missione di distruzione, l'Imperatrice ha inviato il temibile Comandante Scuderi con le sue truppe d'élite di Backoffice, pronte ad annientare la flotta del Demand.</p>
                    <p>CADET PROFILE LOADING...</p>
                    <p>Tu sei un semplice cadetto del Demand Galattico, assegnato alla guida dell'intercettore sperimentale Raptor-X dall'Ammiraglio Condor, valoroso baluardo della speranza della Terra.</p>
                    <p>MISSION DIRECTIVE FOLLOWS:</p>
                    <p>La tua missione è affrontare le truppe Backoffice, penetrare le loro difese e fermare il Comandante Scuderi prima che sia troppo tardi.</p>
                    <p>MISSION STATUS: IN PROGRESS</p>
                    <p>RAPTOR-X CONTROLS INITIALIZED</p>
                    <p>GOOD LUCK, CADET<span class="cursor"></span></p>
                </div>
            </div>
        </div>
        <button id="skipIntroButton">Salta Intro (Spazio)</button>
        <div class="crt-effect"></div>
    </div>

    <!-- Schermata Registrazione Cadetto -->
    <div id="cadetRegistrationScreen">
        <div id="cadetRegistrationContainer">
            <!-- Contenuto generato da renderCadetRegistration() -->
        </div>
    </div>

    <!-- Layout Principale del Gioco -->
    <div id="mainLayout">
        <div id="highScoreContainer">
            <div id="titleHeader">
                 <canvas id="titleLogoCanvas" width="120" height="60"></canvas>
                 <h1>CONDORSPACE</h1>
                 <h2>NETHEX CONTRO IL DEMAND GALATTICO</h2>
            </div>
            <div id="highScoreContent">
                 <h3>WALL OF FAME</h3>
                 <ul id="highScoreList">
                      <li><span>Loading...</span><span></span></li>
                 </ul>
                 <div class="instructions">
                     Frecce/WASD: Muovi<br>
                     Spazio: Spara<br>
                     P: Pausa
                 </div>
            </div>
        </div>
        <div id="canvasWrapper">
            <canvas id="gameCanvas" width="480" height="640" tabindex="0"></canvas>
            <div id="bossHealthBarContainer">
                <div id="bossHealthBar"></div>
                <div id="bossHealthText">CMDR SCUDERI</div>
            </div>
            <button id="startButton" class="overlayButton">Inizia Partita</button>
            <div id="gameOverOverlay">
                <h2>FINE PARTITA</h2>
                <p>Punteggio Finale: <span id="finalScore">0</span></p>
                <div id="highScoreEntry">
                    <label for="playerNameInput">Congratulazioni! Nuovo Record!</label>
                    <input type="text" id="playerNameInput" placeholder="Nome Pilota (3-10)" maxlength="10" minlength="3">
                    <button id="saveScoreButton" class="overlayButton">Salva</button>
                </div>
                <button id="restartButton" class="overlayButton">Ricomincia</button>
            </div>
            <div id="pauseOverlay">PAUSA</div>
            <div id="uiMessageDisplay"></div>
        </div>
        <div id="uiSidebar">
            <h3>STATO</h3>
            <p>Punteggio: <span id="scoreValue">0</span></p>
            <p>Vite: <span id="livesValue">3</span></p>
            <p>Salute: <span id="healthValue">10/10</span></p>
            <div id="healthBarContainer"><div id="healthBar"></div></div>
             <div id="cadetNameContainer">
                 <div>PILOTA</div>
                 <div id="cadetNameDisplay">IN ATTESA...</div>
                 <div>STATO MISSIONE</div>
             </div>
            <p>Arma: <span id="weaponValue">Standard</span></p>
            <p>Stato: <span id="statusValue">OK</span></p>
            <p>Ondata: <span id="waveValue">-</span></p>
            <p>Livello: <span id="levelValue">1</span></p>
            <p>Nemici: <span id="enemiesValue">0</span></p>
        </div>
    </div>

    <!-- === FINE BLOCCO 3 === -->
    <!-- === INIZIO BLOCCO 4 (JavaScript Core, Setup, Classi Oggetti) === -->


    <script>
        /**
         * CONDORSPACE V2.12.2 - Ricostruzione Stabile
         * BLOCCO 4: Core, Variabili Globali, Audio, Helpers, Classi Oggetti
         */

        // --- Scope Globale per Variabili UI e Stato Gioco Principali ---
        let canvas, ctx, startButton, gameOverOverlay, restartButton, finalScoreUI, highScoreEntryUI, playerNameInput, saveScoreButton, highScoreListUI, scoreValueUI, livesValueUI, weaponValueUI, levelValueUI, statusValueUI, waveValueUI, enemiesValueUI, pauseOverlay, uiMessageDisplay, healthValueUI, healthBarUI, healthBarContainer, bossHealthBarContainer, bossHealthBar, bossHealthText, introOverlay, skipIntroButton, mainLayout, titleLogoCanvas, titleLogoCtx, cadetRegistrationScreen, cadetRegistrationContainer, cadetNameDisplayUI, parallaxLogoSplashContainer;
        let animationFrameId = null;
        let gameBoss = null;
        window.introTimeout = null; window.introAudioPlayed = false; window.introOver = false;

        // --- Oggetto Stato Principale del Gioco (`game`) ---
        const game = { animationFrame:0, lastTime:0, deltaTime:0, running:false, paused:false, score:0, lives:3, isGameOver:false, level:1, playerProjectiles:[], aliens:[], alienProjectiles:[], explosions:[], powerUps:[], stars:[], planets:[], crystals:[], globalAlienFireCooldown:0, alienSeparationBuffer:7, currentScoreSubmitted:false, uiMessage:"", uiMessageTimer:0, screenFlashTimer:0, currentWaveIndex:-1, waveTimer:0, timeUntilNextWave:0, inWavePause:true, allWavesCompleted:false, bossSpawned:false, bossDefeated:false, alienSpawnTimer:0, cadetName:"CADETTO", errorNotified:false };
        const spaceship = { x:0,y:0,width:50,height:60,speed:280,thrustPower:0,engineAnimFrame:0,engineFrameCount:0,firing:false,fireDelay:0,fireRate:140,moveLeft:false,moveRight:false,moveUp:false,moveDown:false,weaponType:0,laserBeamActive:false,health:10,maxHealth:10,invincibleAfterHit:false,invincibleAfterLifeLoss:false,hitInvincibleTimer:0,lifeLossInvincibleTimer:0,HIT_INVINCIBILITY_DURATION:1100,LIFE_LOSS_INVINCIBILITY_DURATION:2500,shieldActive:false,shieldTimer:0,SHIELD_DURATION:8500,isAlive:true,blinkTimer:0,takeDamage:function(a){if(!this.isAlive||this.shieldActive||this.invincibleAfterHit||this.invincibleAfterLifeLoss)return;this.health-=a;AudioSystem.playPlayerHitSound();game.screenFlashTimer=SCREEN_FLASH_DURATION;if(this.health<=0){this.health=0;loseLife();}else{this.invincibleAfterHit=true;this.hitInvincibleTimer=this.HIT_INVINCIBILITY_DURATION;}updateGameUI(game,spaceship);} };

        // --- Costanti ---
        const BLINK_INTERVAL=150,UI_MESSAGE_DURATION=1800,SCREEN_FLASH_DURATION=150,ALIEN_PROJECTILE_DAMAGE=1,ALIEN_COLLISION_DAMAGE=3,POWERUP_DROP_CHANCE=0.18,LASER_DPS=15;
        const DEFAULT_EXPLOSION_COLORS={primary:"#ff8800",secondary:"#ffaa44",accent:"#ffffff",glow:"#ff6600",energy:"#ffff88"},DEFAULT_ALIEN_COLORS={primary:"#aa00ff",secondary:"#cc66ff",accent:"#ffffff",glow:"#aa00ff",energy:"#ff00ff"};
        window.alienColorSchemes=[{primary:"#00aaff",secondary:"#80ccff",accent:"#fff",glow:"#00aaff",energy:"#80ffff"},{primary:"#ff5500",secondary:"#ffaa00",accent:"#fff",glow:"#ff5500",energy:"#ffff00"},{primary:"#aa00ff",secondary:"#cc66ff",accent:"#fff",glow:"#aa00ff",energy:"#ff00ff"},{primary:"#00ff66",secondary:"#80ffaa",accent:"#fff",glow:"#00ff66",energy:"#ccff00"},{primary:"#ff0066",secondary:"#ff80aa",accent:"#fff",glow:"#ff0066",energy:"#ffcc66"},{primary:"#cc0000",secondary:"#ff6666",accent:"#fff",glow:"#ff0000",energy:"#ffaaaa"}];
        const HIGH_SCORE_KEY='condorspaceHighScores_v5',MAX_HIGH_SCORES=7;
        let prngSeed=Date.now();function pseudoRandom(){return prngSeed=(prngSeed*9301+49297)%233280,prngSeed/233280}function seededPseudoRandom(e){let t=e%2147483647;return t<=0&&(t+=2147483646),()=>{return t=(t*16807)%2147483647,(t-1)/2147483646}}
        const WAVES=JSON.parse(JSON.stringify([{name:"Ricognitori Nethex",duration:35e3,spawnInterval:1600,maxAliensOnScreen:11,alienTypes:[{type:"scout",params:{health:1,speedY:80,shootCooldown:2600,movement:"straight",speedFactor:.95}},{type:"scout_sine",params:{health:1.2,speedY:70,shootCooldown:2800,movement:"sine",speedFactor:.95,sineAmplitude:55,sineFrequency:.016}}],pauseAfter:3500},{name:"Squadriglie d'Assalto",duration:5e4,spawnInterval:1300,maxAliensOnScreen:15,alienTypes:[{type:"fighter",params:{health:3,speedY:95,shootCooldown:1900,movement:"zigzag",speedFactor:1}},{type:"scout_sine",params:{health:2,speedY:80,shootCooldown:2200,movement:"sine",speedFactor:1,sineAmplitude:75,sineFrequency:.021}}],pauseAfter:4500},{name:"Bombardieri Pesanti",duration:65e3,spawnInterval:1100,maxAliensOnScreen:17,alienTypes:[{type:"bomber",params:{health:7,speedY:65,shootCooldown:1600,movement:"straight",speedFactor:1.1,sizeMultiplier:1.2}},{type:"fighter_elite",params:{health:4,speedY:105,shootCooldown:1700,movement:"diagonal",speedFactor:1.1,isElite:!0}}],pauseAfter:5500},{name:"Guardia Scelta",duration:5e4,spawnInterval:800,maxAliensOnScreen:14,alienTypes:[{type:"elite_guardian",params:{health:6,speedY:125,shootCooldown:1300,movement:"sine",speedFactor:1.2,sineAmplitude:95,sineFrequency:.026,eyeOffset:Math.PI,isElite:!0}},{type:"kamikaze",params:{health:1.5,speedY:200,shootCooldown:99999,movement:"straight_fast",speedFactor:1.5,collisionDamageBoost:6}}],pauseAfter:7e3}]));
        let currentPlanetTypes=[];const starCount=160;const starSpeed=1;const MAX_PLANETS=3;const availablePlanetTypes=[0,6,7,8,9];

        // --- Sistema Audio ---
        const AudioSystem={context:null,sfxGainNode:null,musicGainNode:null,isInitialized:!1,audioUnlockNeeded:!0,musicElements:{},continuousLaserSound:null,audioFiles:{parallaxSplashMusic:"assets/audio/parallax_logo.mp3",introMusic:"assets/audio/intro_music.mp3",gameplayMusic:"assets/audio/gameplay_music.mp3"},init:function(e){if(this.isInitialized){e&&e();return}console.log("INFO: Inizializzazione AudioSystem...");try{window.AudioContext=window.AudioContext||window.webkitAudioContext;if(!window.AudioContext)throw new Error("Web Audio API non supportata.");this.context=new AudioContext;this.sfxGainNode=this.context.createGain();this.sfxGainNode.gain.setValueAtTime(.6,this.context.currentTime);this.sfxGainNode.connect(this.context.destination);this.musicGainNode=this.context.createGain();this.musicGainNode.gain.setValueAtTime(.2,this.context.currentTime);this.musicGainNode.connect(this.context.destination);this.audioUnlockNeeded="suspended"===this.context.state;console.log(`INFO: AudioContext state: ${this.context.state}. Unlock needed: ${this.audioUnlockNeeded}`);this.isInitialized=!0;e&&e()}catch(t){console.error("ERRORE: AudioContext init fallita:",t);this.isInitialized=!1;e&&e()}},resumeContext:function(e){if(!this.context||!this.isInitialized||!this.audioUnlockNeeded){e&&e();return}if("suspended"===this.context.state){console.log("INFO: Tentativo resume AudioContext...");this.context.resume().then(()=>{console.log("INFO: AudioContext ripreso.");this.audioUnlockNeeded=!1;e&&e()}).catch(t=>{console.error("ERRORE: Resume AudioContext fallito:",t);e&&e()})}else{this.audioUnlockNeeded=!1;e&&e()}},playMP3Music:function(e,t,i=.5,s=!0){this.stopAllMP3Music(200);console.log(`INFO: Play MP3 '${e}' from ${t}`);if(this.musicElements[e]){try{this.musicElements[e].pause()}catch(c){}delete this.musicElements[e]}const h=new Audio;h.volume=0;h.loop=s;h.src=t;h.crossOrigin="anonymous";this.musicElements[e]=h;const a=h.play();if(void 0!==a)a.then(()=>{const n=1e3,o=50,l=n/o,r=i/l;let d=0;const u=setInterval(()=>{if(!this.musicElements[e]){clearInterval(u);return}d+=r;if(d>=i){h.volume=i;clearInterval(u)}else h.volume=d},o)}).catch(n=>{console.error(`ERRORE: Play MP3 '${e}' fallito:`,n);delete this.musicElements[e]});h.onerror=n=>{console.error(`ERRORE: Load MP3 '${e}' fallito:`,n);delete this.musicElements[e]}},stopAllMP3Music:function(e=0){console.log(`INFO: Stop MP3 (fade: ${e}ms)`);Object.keys(this.musicElements).forEach(t=>{const i=this.musicElements[t];delete this.musicElements[t];if(!i)return;if(e>0&&i.volume>0){const s=i.volume,h=50,a=e/h,n=s/a,o=setInterval(()=>{const l=i.volume-n;if(l<=0){i.volume=0;i.pause();i.currentTime=0;clearInterval(o)}else i.volume=l},h)}else{i.pause();i.currentTime=0}})},
        playParallaxSplashMusic(){this.playMP3Music('parallaxSplash',this.audioFiles.parallaxSplashMusic,0.45,!1);},playIntroMP3(){this.playMP3Music('intro',this.audioFiles.introMusic,0.35,!0);},playGameplayMP3(){this.playMP3Music('gameplay',this.audioFiles.gameplayMusic,0.25,!0);},
        _createToneSweep:function(e,t,i,s,h=1,a=.01,n=.1,o=null){if(!this.context||!this.sfxGainNode||"running"!==this.context.state)return null;const l=this.context.currentTime,r=null!==o?o:l;try{const c=this.context.createOscillator();c.type=e;const d=this.context.createGain(),f=Math.max(20,t),p=Math.max(20,i);c.frequency.setValueAtTime(f,r);s>.001&&Math.abs(f-p)>1&&c.frequency.exponentialRampToValueAtTime(Math.max(.01,p),r+s);d.gain.setValueAtTime(0,r);a>.001?d.gain.linearRampToValueAtTime(h,r+a):d.gain.setValueAtTime(h,r+a);const m=r+Math.max(a,s);d.gain.setValueAtTime(d.gain.value,m);d.gain.exponentialRampToValueAtTime(.001,m+n);c.connect(d).connect(this.sfxGainNode);c.start(r);c.stop(m+n+.1);return{o:c,g:d}}catch(u){return null;}},_createFilteredNoise:function(e,t,i=1,s=1,h="bandpass",a=null){if(!this.context||!this.sfxGainNode||"running"!==this.context.state)return null;const n=this.context.currentTime,o=null!==a?a:n;try{const l=Math.max(1,Math.floor(this.context.sampleRate*e)),r=this.context.createBuffer(1,l,this.context.sampleRate),c=r.getChannelData(0);for(let d=0;d<l;d++)c[d]=2*Math.random()-1;const f=this.context.createBufferSource();f.buffer=r;f.loop=!1;const p=this.context.createBiquadFilter();p.type=h;p.frequency.setValueAtTime(t,o);p.Q.setValueAtTime(i,o);const m=this.context.createGain();m.gain.setValueAtTime(0,o);m.gain.linearRampToValueAtTime(s,o+.01);m.gain.exponentialRampToValueAtTime(.001,o+e);f.connect(p).connect(m).connect(this.sfxGainNode);f.start(o);return{n:f,f:p,ng:m}}catch(u){return null;}},
        play:function(e){if(!this.context||"running"!==this.context.state||!this.sfxGainNode)return null;const t=this.context.currentTime;switch(e){case"buttonClick":this._createToneSweep("sine",700,0,.03,.2,.001,.02,t);this._createToneSweep("square",1200,800,.015,.1,.001,.01,t+.005);this._createFilteredNoise(.02,3000,10,.05,"bandpass",t);break;case"laser":this._createToneSweep("square",780,380,.11,.38,.005,.06,t);break;case"spread":this._createToneSweep("sawtooth",900,450,.1,.32,.005,.05,t);break;case"rapid":this._createToneSweep("triangle",920,500,.07,.28,.003,.04,t);break;case"heavy":this._createToneSweep("sawtooth",280,140,.22,.48,.01,.25,t);this._createToneSweep("square",560,280,.18,.28,.02,.2,t+.02);break;case"alienLaser":const i="triangle",s=900+400*Math.random(),h=s*(.35+.3*Math.random()),a=.07+.05*Math.random(),n=.22+.1*Math.random();this._createToneSweep(i,s,h,a,n,.005,.05,t);break;case"explosionSmall":this._createFilteredNoise(.3,1600,11,.45,"bandpass",t);this._createToneSweep("square",650,250,.18,.35,.01,.12,t+.02);break;case"explosionMedium":this._createFilteredNoise(.5,900,9,.65,"bandpass",t);this._createToneSweep("sawtooth",450,120,.35,.55,.01,.25,t+.05);this._createToneSweep("square",250,90,.35,.45,.05,.3,t+.1);break;case"explosionLarge":this._createFilteredNoise(1,500,7,.85,"lowpass",t);this._createToneSweep("sawtooth",220,60,.7,.75,.02,.5,t+.05);this._createToneSweep("square",120,50,.8,.65,.1,.6,t+.15);for(let o=0;o<7;o++)this._createFilteredNoise(.06+.04*Math.random(),3500+2500*Math.random(),18+5*Math.random(),.35+.1*Math.random(),"highpass",t+.1+.6*Math.random());break;case"megaExplosion":this._createFilteredNoise(1.8,300,5,1,"lowpass",t);this._createToneSweep("sawtooth",180,40,1.2,.9,.03,.8,t+.05);this._createToneSweep("square",100,30,1.4,.8,.15,1,t+.15);for(let o=0;o<15;o++)this._createFilteredNoise(.1+.15*Math.random(),4e3+3e3*Math.random(),15+10*Math.random(),.4+.3*Math.random(),"highpass",t+.2+1.5*Math.random());this._createToneSweep("sine",80,50,3,.3,1,2,t+.5);break;case"powerup":this._createToneSweep("sine",800,1500,.35,.55,.01,.2,t);this._createToneSweep("sine",1200,1900,.25,.45,.01,.1,t+.1);break;case"shieldUp":this._createToneSweep("sine",440,880,.4,.6,.01,.25,t);this._createToneSweep("triangle",660,1320,.3,.5,.02,.15,t+.1);break;case"shieldDown":this._createToneSweep("sawtooth",660,220,.4,.3,.01,.3,t);break;case"playerHit":this._createToneSweep("sawtooth",500,100,.3,.65,.005,.2,t);this._createFilteredNoise(.3,1200,6,.5,"lowpass",t);break;case"gameOver":this._createToneSweep("sawtooth",400,100,1.2,.5,.05,.6,t);this._createToneSweep("sawtooth",300,80,1.1,.4,.1,.7,t+.2);break;case"gameStart":this._createToneSweep("sawtooth",220,770,.6,.5,.02,.3,t);this._createToneSweep("square",440,990,.5,.4,.01,.2,t+.1);break;case'crystalSmall':this._createToneSweep("sine",440,880,.1,.3,.01,.05,t);this._createToneSweep("triangle",660,770,.05,.2,.01,.03,t+.02);break;case'crystalMedium':this._createToneSweep("sine",440,880,.15,.4,.01,.08,t);this._createToneSweep("triangle",660,1100,.1,.3,.01,.05,t+.05);this._createFilteredNoise(.05,4e3,15,.1,"highpass",t+.02);break;case'crystalLarge':this._createToneSweep("sine",440,880,.15,.5,.01,.1,t);this._createToneSweep("triangle",660,1100,.12,.4,.01,.08,t+.05);this._createToneSweep("sine",880,1320,.1,.3,.01,.05,t+.1);this._createFilteredNoise(.1,3500,12,.15,"highpass",t+.05);break;case'crystalRare':this._createToneSweep("sine",440,880,.15,.6,.01,.12,t);this._createToneSweep("triangle",660,1320,.12,.5,.01,.1,t+.08);this._createToneSweep("sine",880,1760,.1,.4,.01,.08,t+.16);this._createToneSweep("triangle",1320,2200,.08,.3,.01,.05,t+.24);this._createFilteredNoise(.2,3e3,10,.2,"highpass",t+.2);break;default:console.warn(`WARN: Suono non definito: ${e}`)}},
        playButtonSound(){this.play('buttonClick');}, playLaserSound(){this.play('laser');}, playSpreadSound(){this.play('spread');}, playRapidSound(){this.play('rapid');}, playHeavySound(){this.play('heavy');}, playAlienLaserSound(){this.play('alienLaser');}, playExplosionSound(size='small'){if(size==='large')this.play('explosionLarge');else if(size==='medium')this.play('explosionMedium');else this.play('explosionSmall');}, playMegaExplosionSound(){this.play('megaExplosion');}, playPowerUpSound(){this.play('powerup');}, playPlayerHitSound(){this.play('playerHit');}, playGameOverSound(){this.play('gameOver');}, playGameStartSound(){this.play('gameStart');}, playShieldUpSound(){this.play('shieldUp');}, playShieldDownSound(){this.play('shieldDown');}, playCrystalSound(rarity=0){if(rarity>=3)this.play('crystalRare');else if(rarity===2)this.play('crystalLarge');else if(rarity===1)this.play('crystalMedium');else this.play('crystalSmall');},
        startContinuous(){if(!this.context||this.context.state!=='running')return;this.stopContinuous();const n=this.context.currentTime;const o1=this.context.createOscillator();o1.type="sawtooth";const o2=this.context.createOscillator();o2.type="sine";const gn=this.context.createGain();const f=this.context.createBiquadFilter();f.type="bandpass";const l=this.context.createOscillator();l.type="sine";const lg=this.context.createGain();o1.frequency.setValueAtTime(880,n);o1.frequency.linearRampToValueAtTime(920,n+0.1);o2.frequency.setValueAtTime(440,n);gn.gain.setValueAtTime(0,n);gn.gain.linearRampToValueAtTime(0.3,n+0.05);f.frequency.setValueAtTime(2000,n);f.Q.setValueAtTime(5,n);l.frequency.setValueAtTime(8,n);lg.gain.setValueAtTime(400,n);o1.connect(f);o2.connect(f);f.connect(gn).connect(this.sfxGainNode);l.connect(lg).connect(f.frequency);o1.start(n);o2.start(n);l.start(n);this.continuousLaserSound={osc1:o1,osc2:o2,lfo:l,gain:gn,filter:f,lfoGain:lg};},
        stopContinuous(){if(!this.continuousLaserSound||!this.context)return;const n=this.context.currentTime;const s=this.continuousLaserSound;try{s.gain.gain.setValueAtTime(s.gain.gain.value,n);s.gain.gain.linearRampToValueAtTime(0,n+0.1);}catch(e){}try{s.osc1.stop(n+0.15);}catch(e){}try{s.osc2.stop(n+0.15);}catch(e){}try{s.lfo.stop(n+0.15);}catch(e){}this.continuousLaserSound=null;},
        bossMusicNodes:null,
        playProceduralBossMusic:function(){if(!this.context||"running"!==this.context.state||!this.musicGainNode)return;this.stopProceduralBossMusic();console.log("INFO: Avvio musica boss procedurale...");const e=140,t=60/e/2,i=8*t;let s=this.context.currentTime+.1,h=0;this.bossMusicNodes={mainGain:this.context.createGain(),sources:[],scheduler:null};this.bossMusicNodes.mainGain.gain.setValueAtTime(0,this.context.currentTime);this.bossMusicNodes.mainGain.connect(this.musicGainNode);const a=this.musicElements.gameplay&&!this.musicElements.gameplay.paused?.35:.18;this.bossMusicNodes.mainGain.gain.linearRampToValueAtTime(a,this.context.currentTime+.5);const n=(e,t,i,s,h)=>{if(!this.bossMusicNodes||!this.context||"running"!==this.context.state)return;const a=this.context.createOscillator(),n=this.context.createGain();a.type=t;a.frequency.setValueAtTime(e,s);n.gain.setValueAtTime(0,s);n.gain.linearRampToValueAtTime(.7*i,s+.1*h);n.gain.linearRampToValueAtTime(0,s+h);a.connect(n).connect(this.bossMusicNodes.mainGain);a.start(s);const o=s+h+.1;a.stop(o);a.stopTime=o;this.bossMusicNodes.sources.push(a)},o=()=>{if(!this.bossMusicNodes||!game.bossSpawned||game.bossDefeated||!this.context||"running"!==this.context.state){this.stopProceduralBossMusic();return}this.bossMusicNodes.sources=this.bossMusicNodes.sources.filter(l=>l&&this.context.currentTime<(l.stopTime||0));const l=36+h%4*2,r=[0,3,0,5,7,5,3,0],c=440*Math.pow(2,(l-12-69)/12);n(c,"sawtooth",.25,s,.95*i);n(1.01*c,"sawtooth",.2,s+.05*t,.9*i);for(let d=0;d<8;d++)if(Math.random()<.6){const f=r[d%r.length],p=440*Math.pow(2,(l+12+f-69)/12);n(p,"square",.1+Math.random()*.05,s+d*t,t*(.8+.4*Math.random()))}d%2==0&&this._createFilteredNoise(.08,200+200*Math.random(),8,.35,"lowpass",s+d*t),3==d%4&&this._createFilteredNoise(.12,1500+1e3*Math.random(),10,.25,"bandpass",s+d*t);s+=i;h++;const u=(s-this.context.currentTime)*1e3;this.bossMusicNodes.scheduler=setTimeout(o,Math.max(50,u))};o()},
        stopProceduralBossMusic:function(){console.log("INFO: Stop musica boss procedurale.");if(this.bossMusicNodes){this.bossMusicNodes.scheduler&&clearTimeout(this.bossMusicNodes.scheduler);const e=this.context?.currentTime||0;if(this.bossMusicNodes.mainGain&&this.context&&"running"===this.context.state)try{this.bossMusicNodes.mainGain.gain.cancelScheduledValues(e);this.bossMusicNodes.mainGain.gain.setValueAtTime(this.bossMusicNodes.mainGain.gain.value,e);this.bossMusicNodes.mainGain.gain.linearRampToValueAtTime(0,e+.3)}catch(t){} (this.bossMusicNodes.sources||[]).forEach(t=>{try{t&&t.stop&&t.stop(e+.4)}catch(i){}});setTimeout(()=>{try{this.bossMusicNodes?.mainGain?.disconnect()}catch(t){}this.bossMusicNodes=null},400)}}
    };

    // --- Helper Functions ---
    function getRandomColor(){return window.alienColorSchemes[Math.floor(Math.random()*window.alienColorSchemes.length)];}
    function isColliding(rA,rB){return rA.x<rB.x+rB.width&&rA.x+rA.width>rB.x&&rA.y<rB.y+rB.height&&rA.y+rA.height>rB.y;}
    function isSpaceshipCurrentlyVisible(){if(!spaceship.isAlive)return false;if(spaceship.shieldActive)return true;if(!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss)return true;const rem=Math.max(spaceship.hitInvincibleTimer,spaceship.lifeLossInvincibleTimer);return(rem%(BLINK_INTERVAL*2))<BLINK_INTERVAL;}
    function hexToRgba(hex,alpha=1){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');const bI=parseInt(hex,16);if(isNaN(bI))return`rgba(255,255,255,${alpha})`;const r=(bI>>16)&255,g=(bI>>8)&255,b=bI&255;const cA=Math.max(0,Math.min(1,alpha));return`rgba(${r},${g},${b},${cA})`;}

    <!-- === INIZIO BLOCCO 5 (JavaScript Game Object Classes) === -->
    <script>
        // --- Classe Projectile ---
        class Projectile { constructor(x,y,t=0,a=0){this.x=x;this.y=y;this.type=t;this.angle=a;this.active=!0;switch(this.type){case 0:this.width=6;this.height=16;this.speed=600;this.damage=1;break;case 1:this.width=5;this.height=12;this.speed=540;this.damage=1;break;case 2:this.width=4;this.height=12;this.speed=720;this.damage=.75;break;case 3:this.width=10;this.height=20;this.speed=420;this.damage=2.5;break;default:this.width=6;this.height=16;this.speed=600;this.damage=1}}update(e){if(!this.active)return;const t=this.speed*e/1e3;1===this.type?(this.x+=Math.sin(this.angle)*t,this.y-=Math.cos(this.angle)*t):this.y-=t;if(this.y<-this.height||this.x<-this.width||this.x>canvas.width)this.active=!1}draw(e){if(!this.active||!ctx)return;ctx.save();let t,i=0,s="#fff",h="#0ff",a="#0ff";const n=e%4;switch(this.type){case 1:h="#0f6";a="#0f6";break;case 2:h="#fc0";a="#fc0";break;case 3:h="#f06";a="#f06"}t=ctx.createLinearGradient(this.x,this.y,this.x,this.y+this.height);t.addColorStop(0,s);t.addColorStop(1,h);ctx.fillStyle=t;ctx.shadowColor=a;ctx.shadowBlur=8+this.type;ctx.fillRect(this.x,this.y,this.width,this.height);i=1+n;try{ctx.fillStyle=hexToRgba(a,.3)}catch{ctx.fillStyle=a+"4D"}ctx.shadowBlur=0;ctx.fillRect(this.x-i,this.y-i,this.width+2*i,this.height+2*i);ctx.restore()}}

        // --- Classe AlienProjectile ---
        class AlienProjectile{constructor(x,y,s=180,z=5,c="#f44",tracking=0){this.x=x;this.y=y;this.initialSpeed=s+Math.random()*Math.max(1,.3*s);this.speedX=0;this.speedY=this.initialSpeed;this.width=z;this.height=1.5*z;this.color=c;this.active=!0;this.damage=ALIEN_PROJECTILE_DAMAGE;this.trackingFactor=.002*tracking*Math.min(game.level,5);this.turnSpeed=(100+50*Math.random())*(1+tracking);this.lifeTimer=null}update(e){if(!this.active)return;const t=e/1e3;if(this.trackingFactor>0&&spaceship.isAlive){const i=spaceship.x+spaceship.width/2,s=spaceship.y+spaceship.height/2,h=i-this.x,a=s-this.y,n=Math.atan2(a,h);let o=Math.atan2(this.speedX,-this.speedY),l=n-(o+Math.PI/2);for(;l<=-Math.PI;)l+=2*Math.PI;for(;l>Math.PI;)l-=2*Math.PI;const r=Math.min(Math.abs(l),this.turnSpeed*this.trackingFactor*t)*Math.sign(l);o+=r;const c=Math.sqrt(this.speedX*this.speedX+this.speedY*this.speedY);this.speedX=Math.sin(o)*c;this.speedY=-Math.cos(o)*c}this.x+=this.speedX*t;this.y+=this.speedY*t;if(null!==this.lifeTimer&&(this.lifeTimer-=e,this.lifeTimer<=0)){(typeof this.explode=="function"?this.explode():this.active=!1);return}if(spaceship.isAlive&&!spaceship.shieldActive&&isColliding(this,spaceship)){"function"==typeof this.explode?this.explode():this.active=!1,spaceship.takeDamage(ALIEN_COLLISION_DAMAGE+3)}if(this.y>canvas.height+this.height||this.y<-this.height||this.x<-this.width||this.x>canvas.width+this.width)this.active=!1}draw(){if(!this.active||!ctx)return;ctx.save();ctx.fillStyle=this.color;ctx.shadowColor=this.color;ctx.shadowBlur=5+.5*this.width;ctx.beginPath();ctx.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,2*Math.PI);ctx.fill();try{ctx.fillStyle=hexToRgba(this.color,.6)}catch{ctx.fillStyle=this.color+"99"}ctx.shadowBlur=0;ctx.beginPath();ctx.ellipse(this.x+this.width/2,this.y+.2*this.height,this.width/3,this.height/4,0,0,2*Math.PI);ctx.fill();ctx.restore()}}

        // --- Classe Alien ---
        class Alien{constructor(x,y,s,c,m,p){this.id=`${Date.now()}-${Math.random()}`;this.x=x;this.y=y;this.size=s*(p.sizeMultiplier||1);this.colors=c||getRandomColor();this.rotation=Math.random()*Math.PI*2;this.rotationSpeed=(Math.random()-.5)*.03*(p.speedFactor||1);this.pulsePhase=Math.random()*Math.PI*2;this.energyPulse=1;this.shieldOpacity=.4;this.tentaclePhase=Math.random()*Math.PI*2;this.collisionRadius=.8*s;this.width=2*this.collisionRadius;this.height=2*this.collisionRadius;this.maxHealth=p.health;this.health=this.maxHealth;this.damaged=!1;this.damageFrame=0;this.hitEffects=[];this.active=!0;this.speedY=p.speedY*(p.speedFactor||1);this.movementType=m;this.startX=x;this.sineAmplitude=(void 0!==p.sineAmplitude?p.sineAmplitude:15+35*Math.random())*(this.size/30)*(p.sineAmplitudeFactor||1);this.sineFrequency=(void 0!==p.sineFrequency?p.sineFrequency:.012+.02*Math.random())*(p.speedFactor||1)*(p.sineFrequencyFactor||1);this.zigZagSpeedX=(p.speedFactor||1)*(70+110*Math.random());this.zigZagDir=Math.random()<.5?1:-1;this.diagonalDir=this.zigZagDir;this.shootTimer=(p.shootCooldown||3e3)/2+Math.random()*(p.shootCooldown||3e3);this.shootCooldown=p.shootCooldown||3e3;this.collisionDamage=p.collisionDamageBoost?ALIEN_COLLISION_DAMAGE+p.collisionDamageBoost:ALIEN_COLLISION_DAMAGE;this.eyeOffset=p.eyeOffset||0;this.targetPlayer="straight_fast"===this.movementType;this.isElite=p.isElite||!1;this.dropExtraChance=this.isElite?.6:.3}update(e){if(!this.active)return!1;const t=e/1e3,i=e/16.666666666666668;let s=this.x,h=this.y+this.speedY*t;let a=!0;if(this.targetPlayer&&spaceship.isAlive){const n=spaceship.x+spaceship.width/2,o=n-this.x;s+=Math.sign(o)*Math.min(Math.abs(.5*o),.8*this.speedY)*t;a=!1}else switch(this.movementType){case"sine":s=this.startX+Math.sin(game.lastTime*this.sineFrequency+this.pulsePhase)*this.sineAmplitude;break;case"zigzag":s+=this.zigZagSpeedX*this.zigZagDir*t;break;case"diagonal":s+=.7*this.zigZagSpeedX*this.diagonalDir*t;break;default:a=!1}if(a)for(const n of game.aliens){if(n===this||!n.active)continue;const o=s-n.x,l=h-n.y,r=o*o+l*l,c=this.collisionRadius+n.collisionRadius+game.alienSeparationBuffer;if(r<c*c&&Math.abs(o)<.8*c){s=this.x;break}}this.y=h;this.x=s;if("zigzag"===this.movementType||"diagonal"===this.movementType)if(this.x>canvas.width-this.collisionRadius&&this.zigZagDir>0||this.x<this.collisionRadius&&this.zigZagDir<0){this.zigZagDir*=-1;"diagonal"===this.movementType&&(this.diagonalDir*=-1)}this.x=Math.max(this.collisionRadius,Math.min(canvas.width-this.collisionRadius,this.x));this.rotation+=this.rotationSpeed*i;this.energyPulse=.9+.1*Math.sin(game.animationFrame*.06+this.pulsePhase);this.shieldOpacity=.3+.1*Math.sin(game.animationFrame*.04+this.pulsePhase+1);this.tentaclePhase+=.015*i;if(this.damaged&&(this.damageFrame--,this.damageFrame<=0))this.damaged=!1;this.hitEffects=this.hitEffects.filter(n=>(n.life-=.1*i,n.size*=(1-.05*i),n.life>0));if(!this.targetPlayer){this.shootTimer-=e;const n=game.currentWaveIndex>=0&&game.currentWaveIndex<WAVES.length?WAVES[game.currentWaveIndex]:null,o=n?Math.max(2,Math.floor(.4*n.maxAliensOnScreen)):3,l=game.aliens.filter(r=>r.active&&r.shootTimer<500&&!r.targetPlayer).length;if(this.shootTimer<=0&&this.y>-this.size&&this.y<canvas.height-50)if(game.globalAlienFireCooldown<=0&&l<o+Math.floor(game.level/2)){this.shoot();this.shootTimer=this.shootCooldown+(Math.random()-.5)*.3*this.shootCooldown;game.globalAlienFireCooldown=50+50*Math.random()}else this.shootTimer=80+120*Math.random()}game.globalAlienFireCooldown>0&&(game.globalAlienFireCooldown-=e);if(this.y>canvas.height+2*this.size)return this.active=!1,!1;if(spaceship.isAlive&&!spaceship.shieldActive&&!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss&&isColliding(this,spaceship)){spaceship.takeDamage(this.collisionDamage);this.targetPlayer&&(this.health=0);this.takeDamage(5);if(!this.active)return!1}return!0}shoot(){const e=this.x,t=this.y+.5*this.collisionRadius,i=160+5*game.level,s=i+80*(Math.random()-.5),h=Math.max(3,Math.min(8,this.size*(.15+.1*Math.random()))),a=this.colors?.energy||"#f60",n=Math.random()<.2?this.colors?.secondary||a:a,o="elite_guardian"===this.movementType||"fighter_elite"===this.movementType||this.isElite?.1+.15*Math.random():0;game.alienProjectiles.push(new AlienProjectile(e,t,s,h,n,o));AudioSystem.playAlienLaserSound()}
        takeDamage(e){if(!this.active)return!1;this.health-=e;this.damaged=!0;this.damageFrame=6;this.hitEffects.push({x:(Math.random()-.5)*.6*this.collisionRadius,y:(Math.random()-.5)*.6*this.collisionRadius,size:.5*this.collisionRadius*(1+.5*Math.random()),life:1});if(this.health<=0){this.active=!1;let t=Math.floor(2*this.size+5*this.maxHealth);this.targetPlayer&&(t=Math.floor(.5*t));this.isElite&&(t=Math.floor(1.5*t));game.score+=t;let i="small";this.size>45?i="large":this.size>30&&(i="medium");const s=this.colors&&"object"==typeof this.colors?this.colors:DEFAULT_ALIEN_COLORS;game.explosions.push(new Explosion(this.x,this.y,1.2*this.size,s,i));AudioSystem.playExplosionSound(i);if(!this.targetPlayer){Math.random()<POWERUP_DROP_CHANCE&&spawnPowerUp(this.x,this.y);"function"==typeof spawnCrystalsFromAlien&&spawnCrystalsFromAlien(this)}return!0}return!1}
        drawTentacles(){const e=5+Math.floor(this.size/15),t=1.8*this.size*this.energyPulse;ctx.lineWidth=Math.max(1,.1*this.size);ctx.lineCap="round";const i=this.colors?.energy||"#80ffff";for(let s=0;s<e;s++){const h=(s/e)*Math.PI*2+this.rotation+.5*this.pulsePhase,a=t*(.6+.4*Math.sin(game.animationFrame*.07+this.tentaclePhase+s*.9)),n=ctx.createLinearGradient(0,0,Math.cos(h)*a,Math.sin(h)*a);try{n.addColorStop(0,hexToRgba(i,.67));n.addColorStop(.7,hexToRgba(i,.27));n.addColorStop(1,hexToRgba(i,0))}catch{n.addColorStop(0,i+"AA");n.addColorStop(1,i+"00")}ctx.strokeStyle=n;ctx.beginPath();ctx.moveTo(0,0);const o=6;let l=0,r=0;for(let c=1;c<=o;c++){const d=c/o,f=a*d,p=.18*this.size*d*d,g=Math.sin(2.5*d+game.animationFrame*.1+this.tentaclePhase+s)*(p/Math.max(1,f)),m=h+g,u=Math.cos(m)*f,w=Math.sin(m)*f;ctx.quadraticCurveTo(l+(u-l)*.5,r+(w-r)*.5,u,w);l=u;r=w}ctx.stroke()}}
        draw(){if(!this.active||!ctx)return;ctx.save();ctx.translate(this.x,this.y);this.drawTentacles();if(this.damaged&&game.animationFrame%2==0){ctx.fillStyle="rgba(255,100,100,0.5)";ctx.beginPath();ctx.arc(0,0,1.1*this.size,0,2*Math.PI);ctx.fill();}if(this.health<this.maxHealth&&!this.targetPlayer){const e=1.5*this.collisionRadius,t=Math.max(4,.1*this.collisionRadius),i=-this.collisionRadius-2.5*t,s=e*(this.health/this.maxHealth);ctx.fillStyle="rgba(50,50,50,0.6)";ctx.fillRect(-e/2,i,e,t);ctx.fillStyle=this.health/this.maxHealth>.5?"#4f4":this.health/this.maxHealth>.2?"#ff4":"#f44";ctx.fillRect(-e/2,i,s,t)}const e=this.size*(1.3+.15*Math.sin(game.animationFrame*.05+this.pulsePhase)),t=ctx.createRadialGradient(0,0,.1*this.size,0,0,e),i=this.colors?.glow||"#0af";try{t.addColorStop(0,hexToRgba(i,.18));t.addColorStop(.5,hexToRgba(i,.08));t.addColorStop(1,hexToRgba(i,0))}catch{t.addColorStop(0,i+"30");t.addColorStop(1,i+"00")}ctx.fillStyle=t;ctx.beginPath();ctx.arc(0,0,e,0,2*Math.PI);ctx.fill();const s=ctx.createRadialGradient(0,0,.2*this.size,0,0,this.size),h=this.colors?.secondary||"#8cf";try{s.addColorStop(0,"rgba(255,255,255,0)");s.addColorStop(.7,hexToRgba(h,.1));s.addColorStop(.9,hexToRgba(h,.2));s.addColorStop(1,hexToRgba(h,.3))}catch{s.addColorStop(.7,h+"1A");s.addColorStop(1,h+"4D")}ctx.fillStyle=s;ctx.globalAlpha=this.shieldOpacity;ctx.beginPath();ctx.arc(0,0,this.size,0,2*Math.PI);ctx.fill();ctx.globalAlpha=1;ctx.rotate(this.rotation);const a=6,n=.7*this.size,o=.85*n;ctx.lineWidth=Math.max(1,.08*this.size);ctx.strokeStyle=this.colors?.primary||"#0af";ctx.beginPath();for(let l=0;l<a;l++){const r=(l/a)*Math.PI*2,c=Math.cos(r)*n,d=Math.sin(r)*n;0===l?ctx.moveTo(c,d):ctx.lineTo(c,d)}ctx.closePath();ctx.stroke();ctx.lineWidth=Math.max(.5,.03*this.size);ctx.strokeStyle=this.colors?.secondary||"#8cf";for(let l=0;l<a;l++){const r=(l/a)*Math.PI*2+Math.PI/a,c=Math.cos(r)*o,d=Math.sin(r)*o;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(c,d);ctx.stroke()}const l=.3*this.size*this.energyPulse;if(l>.5){const r=ctx.createRadialGradient(0,0,.1*l,0,0,l),c=this.colors?.energy||"#8ff",d=this.colors?.primary||"#0af";r.addColorStop(0,"#fff");r.addColorStop(.3,c);r.addColorStop(1,d);ctx.fillStyle=r;ctx.beginPath();ctx.arc(0,0,l,0,2*Math.PI);ctx.fill();ctx.lineWidth=Math.max(.5,.02*this.size);ctx.strokeStyle=this.colors?.accent||"#fff";ctx.beginPath();ctx.arc(0,0,1.3*l,0,2*Math.PI);ctx.stroke()}const r=this.eyeOffset||0,c=this.targetPlayer?1:3,d=this.targetPlayer?Math.PI:Math.PI/6,f=l*(this.targetPlayer?2:1.8),p=[];1===c?p.push({a:d+r,d:f}):(p.push({a:-d+r,d:f}),p.push({a:d+r,d:f}),p.push({a:Math.PI+r,d:f}));const m=this.colors?.energy||"#8ff";ctx.shadowColor=m;ctx.shadowBlur=.1*this.size;ctx.fillStyle=m;if(l>.1){for(const g of p){const u=Math.cos(g.a)*g.d,w=Math.sin(g.a)*g.d,k=Math.max(1,.07*this.size*(.8+.2*Math.sin(game.animationFrame*.1+this.pulsePhase+g.a)));ctx.beginPath();ctx.arc(u,w,k,0,2*Math.PI);ctx.fill()}}ctx.shadowBlur=0;for(const g of this.hitEffects){ctx.globalAlpha=g.life;const u=ctx.createRadialGradient(g.x,g.y,0,g.x,g.y,g.size);u.addColorStop(0,"rgba(255,255,200,0.9)");u.addColorStop(.5,"rgba(255,200,0,0.7)");u.addColorStop(1,"rgba(255,255,255,0)");ctx.fillStyle=u;ctx.beginPath();ctx.arc(g.x,g.y,Math.max(1,g.size),0,2*Math.PI);ctx.fill();ctx.globalAlpha=1}if(this.isElite){ctx.lineWidth=Math.max(.5,.03*this.size);ctx.strokeStyle="rgba(255,255,0,0.6)";const g=2*Math.sin(game.animationFrame*.08);ctx.beginPath();ctx.arc(0,0,1.1*this.size+g,0,2*Math.PI);ctx.stroke()}ctx.restore()}}

    // --- Classe Explosion ---
    class Explosion{constructor(x,y,s,c,z="small"){this.x=x;this.y=y;this.baseSize=s;this.colors={primary:c?.primary||DEFAULT_EXPLOSION_COLORS.primary,secondary:c?.secondary||DEFAULT_EXPLOSION_COLORS.secondary,accent:c?.accent||DEFAULT_EXPLOSION_COLORS.accent,glow:c?.glow||DEFAULT_EXPLOSION_COLORS.glow,energy:c?.energy||DEFAULT_EXPLOSION_COLORS.energy};this.particles=[];this.life=1;this.active=!0;this.sizeCategory=z;this.type=c?.type||"explosion";"explosion"===this.type&&"custom"!==z?this.createParticles():"beam"===this.type&&(this.life=c.life||1e3,this.startTime=c.startTime||Date.now(),this.drawBeam=c.draw,this.dps=c.dps||0,this.bossRef=c.bossRef)}createParticles(){let e=1,t=this.baseSize/12,i=3.5,s=1.6,h=.3;"medium"===this.sizeCategory?(e=2,t=this.baseSize/10,i=4.5,s=2,h=.5):"large"===this.sizeCategory&&(e=3.5,t=this.baseSize/8,i=5.5,s=2.5,h=.7);const a=Math.floor(20*e+12*e*Math.random()),n=this.colors.primary,o=this.colors.energy;for(let l=0;l<a;l++){const r=Math.random()<h;this.particles.push({type:r?"fragment":"square",x:(Math.random()-.5)*.1*this.baseSize,y:(Math.random()-.5)*.1*this.baseSize,size:Math.random()*t+.6*t,speed:(Math.random()*i+.6*i)*(r?1.1:.9),angle:2*Math.random()*Math.PI,rotation:2*Math.random()*Math.PI,rotationSpeed:(Math.random()-.5)*.15,color:Math.random()>.4?n:o,life:1+.6*Math.random(),decay:.01+.015*Math.random()})}const c=this.colors.energy,d=this.colors.primary;if("medium"===this.sizeCategory||"large"===this.sizeCategory){const f="large"===this.sizeCategory?3:2;for(let p=0;p<f;p++)this.particles.push({type:"shockwave",size:0,maxSize:this.baseSize*(s+p*.4),speed:(.9*i+1.8*p)*(.9+.3*Math.random()),opacity:.8-.18*p,color:p%2==0?c:d,life:1,decay:.016+3e-3*p})}this.particles.push({type:"flash",size:1.5*this.baseSize,life:.4,decay:.05})}update(e){if(!this.active)return!1;if("beam"===this.type)return this.active;const t=e/16.666666666666668;this.life-=.015*t;let i=!1;for(let s=this.particles.length-1;s>=0;s--){const h=this.particles[s];h.life-=h.decay*t;if(h.life<=0){this.particles.splice(s,1);continue}i=!0;switch(h.type){case"shockwave":h.size+=h.speed*Math.max(.1,h.life)*t;h.opacity=Math.max(0,h.opacity-1.2*h.decay*t);h.speed*=(1-.015*t);break;case"flash":h.size*=(1+.5*h.decay*t);break;default:h.x+=Math.cos(h.angle)*h.speed*Math.max(.1,h.life)*t;h.y+=Math.sin(h.angle)*h.speed*Math.max(.1,h.life)*t;h.rotation+=h.rotationSpeed*t;h.speed*=(1-(.03+h.decay)*t);h.size=Math.max(0,h.size-20*h.decay*t)}}if(this.life<=0&&!i)this.active=!1;return this.active}draw(e){if(!this.active||!e)return;if("beam"===this.type&&this.drawBeam){this.drawBeam(e);return}e.save();e.translate(this.x,this.y);const t=this.colors.accent||"#fff",i=this.colors.energy||"#ff0",s=this.colors.primary||"#f80";e.globalCompositeOperation="source-over";this.particles.forEach(h=>{if(h.life>0&&h.size>=.5&&"shockwave"!==h.type&&"flash"!==h.type){e.save();e.translate(h.x,h.y);e.rotate(h.rotation);e.globalAlpha=Math.max(0,1.2*h.life);e.fillStyle=h.color;if("fragment"===h.type){e.beginPath();const a=.5*h.size;e.moveTo(0,-1.2*a);e.lineTo(a,.8*a);e.lineTo(-a,.8*a);e.closePath();e.fill()}else e.fillRect(-h.size/2,-h.size/2,h.size,h.size);e.restore()}});e.globalCompositeOperation="lighter";this.particles.forEach(h=>{if(h.life>0&&"flash"===h.type)try{const a=.05*h.life*h.size,n=e.createRadialGradient(0,0,0,0,0,a);n.addColorStop(0,t+"FF");n.addColorStop(.2,i+"CC");n.addColorStop(.6,s+"99");n.addColorStop(1,s+"00");e.fillStyle=n;e.globalAlpha=Math.max(0,2.5*h.life);e.beginPath();e.arc(0,0,a,0,2*Math.PI);e.fill()}catch(o){}});this.particles.forEach(h=>{if(h.life>0&&h.size>=1&&"shockwave"===h.type){e.globalAlpha=h.opacity*h.life;e.strokeStyle=h.color;e.lineWidth=Math.max(1,this.baseSize/20*h.life*(1.5+(h.maxSize/this.baseSize)*.1));e.beginPath();e.arc(0,0,h.size,0,2*Math.PI);e.stroke()}});e.restore()}}

    // --- Classe PowerUp ---
    class PowerUp{constructor(x,y,t){this.x=x;this.y=y;this.width=28;this.height=28;this.type=t;this.speed=110+40*Math.random();this.active=!0;this.rotationAngle=2*Math.random()*Math.PI;this.pulseSize=0;this.pulseSpeed=.08+.04*Math.random();this.rotationSpeed=(Math.random()-.5)*.05}update(e){if(!this.active)return;this.y+=this.speed*e/1e3;this.rotationAngle+=this.rotationSpeed*e/16.666666666666668;this.pulseSize=2.5*Math.sin(game.animationFrame*this.pulseSpeed);if(this.y>canvas.height+this.height){this.active=!1;return}if(spaceship.isAlive&&isColliding(this,{x:spaceship.x+.1*spaceship.width,y:spaceship.y+.1*spaceship.height,width:.8*spaceship.width,height:.8*spaceship.height})){let t="",i="#ffff88",s=!0,h="powerup";5===this.type?(spaceship.shieldActive=!0,spaceship.shieldTimer=spaceship.SHIELD_DURATION,h="shieldUp",game.uiMessage="Scudo Attivato!",i="#80ffff"):6===this.type?(t=spaceship.health,spaceship.health=Math.min(spaceship.maxHealth,spaceship.health+4),h="powerup",game.uiMessage=t<spaceship.maxHealth?"Riparazione!":"Salute Max!",i="#8f8"):(spaceship.weaponType===this.type?(game.score+=250,s=!1):spaceship.weaponType=this.type,spaceship.laserBeamActive&&4!==this.type&&(AudioSystem&&AudioSystem.stopContinuous(),spaceship.laserBeamActive=!1),(()=>{switch(this.type){case 1:t="Spread";i="#6fa";h="spread";break;case 2:t="Rapid";i="#fe8";h="rapid";break;case 3:t="Heavy";i="#f9b";h="heavy";break;case 4:t="Laser";i="#e8f";h="laser"}})(),s&&(game.uiMessage=`Arma: ${t}!`));if(s&&uiMessageDisplay){game.uiMessageTimer=UI_MESSAGE_DURATION;uiMessageDisplay.style.color=i;uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add("visible")}AudioSystem&&AudioSystem.play(h);this.active=!1;updateGameUI(game,spaceship)}}}draw(){if(!this.active||!ctx)return;ctx.save();ctx.translate(this.x+this.width/2,this.y+this.height/2);ctx.rotate(this.rotationAngle);let e="#fff",t="#aaa",i="#fff",s="?";const h=this.width/2+this.pulseSize/2;switch(this.type){case 1:e="#6fa";t="#082";i="#0f6";s="S";break;case 2:e="#fe8";t="#c90";i="#fc0";s="R";break;case 3:e="#f9b";t="#c04";i="#f06";s="H";break;case 4:e="#e8f";t="#80c";i="#c1f";s="L";break;case 5:e="#8df";t="#069";i="#0af";s="";break;case 6:e="#8f8";t="#060";i="#4f4";s="+";break}ctx.shadowColor=i;ctx.shadowBlur=15+1.5*this.pulseSize;const a=ctx.createRadialGradient(0,0,3,0,0,h);try{a.addColorStop(0,"#fff");a.addColorStop(.4,e);a.addColorStop(1,t)}catch{a.addColorStop(0,e);a.addColorStop(1,t)}ctx.fillStyle=a;ctx.beginPath();ctx.arc(0,0,h,0,2*Math.PI);ctx.fill();ctx.strokeStyle=e+"aa";ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(0,0,h+1,0,2*Math.PI);ctx.stroke();ctx.shadowBlur=0;if(5===this.type){const n=.8*h+1.5*Math.sin(game.animationFrame*.15);ctx.fillStyle="#0af";ctx.strokeStyle="#fff";ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,-.6*n);ctx.lineTo(.5*n,-.1*n);ctx.lineTo(.4*n,.5*n);ctx.lineTo(0,.7*n);ctx.lineTo(-.4*n,.5*n);ctx.lineTo(-.5*n,-.1*n);ctx.closePath();ctx.fill();ctx.stroke()}else{ctx.fillStyle="#fff";ctx.font=`bold ${1.2*h}px VT323`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(s,0,1)}ctx.restore()}}

    // --- Classe Crystal (Esagonale - Implementazione Fornita) ---
    class Crystal { constructor(x,y,t=0){this.x=x;this.y=y;this.type=t;switch(this.type){case 1:this.width=20;this.height=20;this.value=250;this.speed=80+25*Math.random();this.color={primary:"rgba(46,204,113,0.8)",secondary:"rgba(39,174,96,0.6)",highlight:"rgba(200,255,213,0.9)",glow:"#6de896"};break;case 2:this.width=25;this.height=25;this.value=500;this.speed=70+20*Math.random();this.color={primary:"rgba(230,126,34,0.8)",secondary:"rgba(211,84,0,0.6)",highlight:"rgba(255,224,178,0.9)",glow:"#f5ab6e"};break;case 3:this.width=30;this.height=30;this.value=1e3;this.speed=60+15*Math.random();this.color={primary:"rgba(155,89,182,0.8)",secondary:"rgba(142,68,173,0.6)",highlight:"rgba(225,190,231,0.9)",glow:"#c39bd3"};break;default:this.width=15;this.height=15;this.value=100;this.speed=90+30*Math.random();this.color={primary:"rgba(52,152,219,0.8)",secondary:"rgba(41,128,185,0.6)",highlight:"rgba(179,229,252,0.9)",glow:"#6ab7ff"}}this.active=!0;this.rotationAngle=2*Math.random()*Math.PI;this.rotationSpeed=(Math.random()-.5)*.05;this.pulseSize=0;this.pulseSpeed=.08+.04*Math.random();this.innerPulse=0;this.innerPulseSpeed=.05+.03*Math.random();this.reflections=[];this.generateReflections();this.isBeingAttracted=!1;this.attractionSpeed=0;this.maxAttractionSpeed=500;this.attractionAcceleration=2e3}generateReflections(){const e=2+Math.floor(3*Math.random());this.reflections=[];for(let t=0;t<e;t++)this.reflections.push({x:(Math.random()-.5)*.6,y:(Math.random()-.5)*.6,size:.1+.3*Math.random(),angle:2*Math.random()*Math.PI,speed:.01+.03*Math.random()})}update(e,t){if(!this.active)return;const i=e/1e3;this.pulseSize=2*Math.sin(game.animationFrame*this.pulseSpeed);this.rotationAngle+=this.rotationSpeed*i*60;this.innerPulse=.7+.3*Math.sin(game.animationFrame*this.innerPulseSpeed);for(let s of this.reflections)s.angle+=s.speed*i*60;const h=150;if(t&&t.isAlive){const a=(t.x+t.width/2)-(this.x+this.width/2),n=(t.y+t.height/2)-(this.y+this.height/2),o=a*a+n*n;if(o<h*h){this.isBeingAttracted=!0;const l=Math.sqrt(o),r=a/l,c=n/l;this.attractionSpeed=Math.min(this.attractionSpeed+this.attractionAcceleration*i,this.maxAttractionSpeed);const d=1-l/h,f=this.attractionSpeed*d;this.x+=r*f*i;this.y+=c*f*i;if(isColliding(this,t)){this.active=!1;game.score+=this.value;createCrystalCollectEffect(this.x+this.width/2,this.y+this.height/2,this.color);playCrystalCollectSound(this.type);return}}else this.isBeingAttracted=!1,this.attractionSpeed=0,this.y+=this.speed*i}else this.y+=this.speed*i;if(this.y>canvas.height+this.height)this.active=!1}draw(e){if(!this.active||!e)return;e.save();e.translate(this.x+this.width/2,this.y+this.height/2);e.rotate(this.rotationAngle);const t=this.width+this.pulseSize;e.shadowColor=this.color.glow;e.shadowBlur=15+this.pulseSize;this.drawHexCrystal(e,t);e.shadowBlur=0;e.restore();if(this.isBeingAttracted){e.save();const i=Math.min(1,this.attractionSpeed/this.maxAttractionSpeed);e.strokeStyle=`rgba(255,255,255,${.4*i})`;e.lineWidth=1;e.setLineDash([5,5]);e.beginPath();e.moveTo(this.x+this.width/2,this.y+this.height/2);e.lineTo(spaceship.x+spaceship.width/2,spaceship.y+spaceship.height/2);e.stroke();e.restore()}}drawHexCrystal(e,t){const i=6,s=2*Math.PI/i,h=t/2;e.beginPath();for(let a=0;a<i;a++){const n=a*s-Math.PI/6,o=Math.cos(n)*h,l=Math.sin(n)*h;0===a?e.moveTo(o,l):e.lineTo(o,l)}e.closePath();const a=e.createRadialGradient(0,0,h*this.innerPulse,0,0,h);a.addColorStop(0,this.color.primary);a.addColorStop(.7,this.color.secondary);a.addColorStop(1,this.color.primary);e.fillStyle=a;e.fill();e.strokeStyle=this.color.highlight;e.lineWidth=1.5;e.stroke();e.beginPath();e.moveTo(0,-h);e.lineTo(0,h);e.strokeStyle=this.color.highlight+"60";e.lineWidth=1;e.stroke();e.beginPath();e.moveTo(-.866*h,-.5*h);e.lineTo(.866*h,.5*h);e.strokeStyle=this.color.highlight+"50";e.lineWidth=.5;e.stroke();e.beginPath();e.moveTo(-.866*h,.5*h);e.lineTo(.866*h,-.5*h);e.stroke();for(let n of this.reflections){const o=.6*h*n.x,l=.6*h*n.y,r=.3*h*n.size;e.beginPath();e.arc(o,l,r,0,2*Math.PI);const c=e.createRadialGradient(o,l,0,o,l,r);c.addColorStop(0,this.color.highlight);c.addColorStop(1,"rgba(255,255,255,0)");e.fillStyle=c;e.fill()}const o=2+Math.floor(this.type);for(let l=0;l<o;l++){const r=(game.animationFrame*.01+l*Math.PI*2/o)%(2*Math.PI),c=.7*h*Math.sin(game.animationFrame*.03+l),d=Math.cos(r)*c*.5,f=Math.sin(r)*c*.5;e.fillStyle="rgba(255,255,255,0.8)";e.beginPath();e.arc(d,f,1+Math.random(),0,2*Math.PI);e.fill()}}}

    // --- Classe Planet ---
    class Planet{constructor(x,y,s,t,d){this.x=x;this.y=y;this.size=s;this.type=t;this.depth=d;this.speed=starSpeed*(.18+d*.22);this.featureSeed=Math.floor(pseudoRandom()*1e4);this.rotationAngle=pseudoRandom()*Math.PI*2;this.rotationSpeed=(pseudoRandom()-.5)*4e-4*(1/(this.speed+.1));this.active=!0}update(e){if(!this.active)return!1;const t=e/16.666666666666668;this.y+=this.speed*t;this.rotationAngle+=this.rotationSpeed*t;if(this.y-this.size>canvas.height){this.active=!1;const i=currentPlanetTypes.indexOf(this.type);i>-1&&currentPlanetTypes.splice(i,1)}return this.active}draw(){if(!this.active||!isFinite(this.x)||!isFinite(this.y)||!isFinite(this.size)||this.size<=0||!ctx)return;ctx.save();ctx.globalAlpha=.5+(1-this.depth)*.5;ctx.translate(this.x,this.y);ctx.rotate(this.rotationAngle);let e,t,i,s,h,a;switch(this.type){case 0:e="rgb(30,70,130)";t="rgb(70,130,180)";i="rgb(20,50,100)";h="rgba(100,160,210,0.8)";s="rgba(15,35,65,0.6)";a="rgba(180,210,240,0.6)";break;case 6:e="rgb(40,120,60)";t="rgb(100,180,100)";i="rgb(20,80,40)";h="rgba(130,200,140,0.8)";s="rgba(15,60,30,0.6)";a="rgba(180,220,190,0.6)";break;case 7:e="rgb(80,10,10)";t="rgb(120,30,30)";i="rgb(60,5,5)";h="rgba(150,40,40,0.8)";s="rgba(40,5,5,0.6)";a="rgba(180,60,60,0.6)";break;case 8:e="rgb(80,30,130)";t="rgb(130,70,180)";i="rgb(50,20,100)";h="rgba(160,100,210,0.8)";s="rgba(40,15,65,0.6)";a="rgba(200,150,240,0.6)";break;default:e="rgb(50,50,50)";t="rgb(100,100,100)";i="rgb(30,30,30)";h="rgba(140,140,140,0.8)";s="rgba(20,20,20,0.6)";a="rgba(180,180,180,0.6)"}try{const n=ctx.createRadialGradient(-.3*this.size,-.4*this.size,.1*this.size,0,0,this.size);n.addColorStop(0,t);n.addColorStop(.6,e);n.addColorStop(1,i);ctx.fillStyle=n;ctx.beginPath();ctx.arc(0,0,this.size,0,2*Math.PI);ctx.fill()}catch(o){ctx.restore();return}const n=seededPseudoRandom(this.featureSeed),l=4+Math.floor(6*n());for(let r=0;r<l;r++){const c=2*n()*Math.PI,d=.85*n()*this.size,f=Math.cos(c)*d,p=Math.sin(c)*d,m=this.size*(.04+.12*n()),u=c+Math.PI+.4*(n()-.5);ctx.save();ctx.translate(f,p);ctx.fillStyle=s;ctx.beginPath();ctx.arc(0,0,m,0,2*Math.PI);ctx.fill();ctx.strokeStyle=a;ctx.lineWidth=Math.max(.5,.15*m+.1*n()*m);ctx.lineCap="round";ctx.beginPath();ctx.arc(0,0,.92*m,u-.5*Math.PI,u+.5*Math.PI);ctx.stroke();ctx.strokeStyle=h;ctx.beginPath();ctx.arc(0,0,.9*m,u+.5*Math.PI,u+1.5*Math.PI);ctx.stroke();m>.1*this.size&&n()>.4&&(ctx.fillStyle=a+"99",ctx.beginPath(),ctx.arc(0,0,.2*m,0,2*Math.PI),ctx.fill());ctx.restore()}const w=ctx.createRadialGradient(0,0,.9*this.size,0,0,1.1*this.size);w.addColorStop(0,"rgba(255,255,255,0)");try{w.addColorStop(.5,hexToRgba(t,.05))}catch{w.addColorStop(.5,"rgba(200,200,200,0.05)")}w.addColorStop(1,"rgba(255,255,255,0)");ctx.fillStyle=w;ctx.beginPath();ctx.arc(0,0,1.1*this.size,0,2*Math.PI);ctx.fill();ctx.restore()}}

    // --- Classe Boss ---
    class Boss{constructor(){this.x=canvas.width/2;this.y=-250;this.width=280;this.height=220;this.active=!1;this.isEntering=!0;this.targetY=100;this.entrySpeed=70;this.moveSpeed=45;this.direction=1;this.phase=0;this.phaseChangeFlash=0;this.attackCooldown=2e3;this.isVisible=!1;this.colors={primary:"#600",secondary:"#a00",accent:"#fcc",glow:"#f00",energy:"#f88",shield:"#8ff"};this.components={mainBody:{name:"Corpo",x:0,y:0,width:this.width,height:this.height,health:9999,maxHealth:9999,active:!0,isCore:!1,draw:this.drawMainBody.bind(this),isHittable:!1},shieldGenerator:{name:"Generatore Scudo",x:0,y:-.4*this.height,width:80,height:40,health:150,maxHealth:150,active:!0,isCore:!1,shieldActive:!0,shieldRadius:.65*this.width,shieldPulse:0,draw:this.drawShieldGenerator.bind(this),isHittable:!0},leftTurret:{name:"Torretta Sinistra",x:-.3*this.width,y:-.1*this.height,width:60,height:60,health:180,maxHealth:180,active:!0,isCore:!1,cooldown:3e3,timer:3e3,draw:this.drawTurret.bind(this,-1),isHittable:!0},rightTurret:{name:"Torretta Destra",x:.3*this.width,y:-.1*this.height,width:60,height:60,health:180,maxHealth:180,active:!0,isCore:!1,cooldown:3e3,timer:3e3,draw:this.drawTurret.bind(this,1),isHittable:!0},core:{name:"Nucleo",x:0,y:.35*this.height,width:70,height:50,health:400,maxHealth:400,active:!1,isCore:!0,draw:this.drawCore.bind(this),isHittable:!1}};this.totalMaxHealth=Object.values(this.components).filter(e=>e.isHittable).reduce((e,t)=>e+t.maxHealth,0);this.currentTotalHealth=this.totalMaxHealth;this.attackPatterns=[{name:"Turret Fire",minPhase:0,execute:()=>{},internal:!0},{name:"Laser Sweep",minPhase:0,cooldown:6e3,timer:0,execute:this.laserSweep.bind(this)},{name:"Missile Volley",minPhase:1,cooldown:8e3,timer:0,execute:this.missileVolley.bind(this)},{name:"Mine Field",minPhase:1,cooldown:14e3,timer:0,execute:this.mineField.bind(this)},{name:"Beam Cannon",minPhase:2,cooldown:1e4,timer:0,execute:this.beamCannon.bind(this)},{name:"Summon Reinforcements",minPhase:1,cooldown:18e3,timer:0,execute:this.summonReinforcements.bind(this)}]}spawn(){this.active=!0;this.isVisible=!0;this.isEntering=!0;this.y=-1.5*this.height;game.bossSpawned=!0;console.log("BOSS SPAWN!");AudioSystem&&(AudioSystem.stopAllMP3Music(200),AudioSystem.play("bossMusicProcedural") /* Cambiato in musica boss procedurale */ );bossHealthBarContainer&&(bossHealthBarContainer.style.display="block");this.updateTotalHealth()}update(e){if(!this.active)return;const t=e/1e3;if(this.isEntering){this.y+=this.entrySpeed*t;if(this.y>=this.targetY){this.y=this.targetY;this.isEntering=!1;this.determinePhase();console.log("Boss in pos.")}return}this.x+=this.moveSpeed*this.direction*t;const i=this.width/2;if(this.direction>0&&this.x+i>canvas.width-20||this.direction<0&&this.x-i<20){this.direction*=-1;this.x+=2*this.moveSpeed*this.direction*t;this.x=Math.max(20+i,Math.min(canvas.width-20-i,this.x))}const s=this.phase;this.determinePhase();s<this.phase&&(this.phaseChangeFlash=300,AudioSystem&&AudioSystem.playShieldUpSound(),console.log(`Boss Fase ${this.phase+1}`),this.moveSpeed*=1.15,this.components.leftTurret.timer=.5*this.components.leftTurret.cooldown,this.components.rightTurret.timer=.5*this.components.rightTurret.cooldown);this.phaseChangeFlash>0&&(this.phaseChangeFlash-=e);this.attackCooldown-=e;Object.values(this.components).forEach(h=>{h.timer>0&&(h.timer-=e)});this.attackPatterns.forEach(h=>{h.timer>0&&(h.timer-=e)});this.handleComponentAttacks(e);if(this.attackCooldown<=0){this.executeAttackPattern();this.attackCooldown=(1500+2e3*Math.random())/(1+.1*this.phase)}this.components.shieldGenerator.shieldActive&&(this.components.shieldGenerator.shieldPulse=4*Math.sin(game.animationFrame*.08))}handleComponentAttacks(e){const t=this.components.leftTurret;t.active&&t.timer<=0&&(this.fireTurretLaser(t.x,t.y+.3*t.height),t.timer=t.cooldown*(.8+.4*Math.random())/(1+.2*this.phase));const i=this.components.rightTurret;i.active&&i.timer<=0&&(this.fireTurretLaser(i.x,i.y+.3*i.height),i.timer=i.cooldown*(.8+.4*Math.random())/(1+.2*this.phase))}executeAttackPattern(){const e=this.attackPatterns.filter(t=>this.phase>=t.minPhase&&!t.internal&&t.timer<=0);e.length>0?(e[Math.floor(Math.random()*e.length)].execute(),e[Math.floor(Math.random()*e.length)].timer=e[Math.floor(Math.random()*e.length)].cooldown/(1+.15*this.phase)):this.attackCooldown=500}fireTurretLaser(e,t){const i=this.x+e,s=this.y+t,h=300+60*Math.random()+20*this.phase,a=.05+.03*this.phase;game.alienProjectiles.push(new AlienProjectile(i,s,h,8,this.colors.energy,a));AudioSystem&&AudioSystem.playAlienLaserSound()}laserSweep(){const e=Math.PI/2.5,t=9+2*this.phase,i=e/(t-1),s=-e/2,h=this.y+.2*this.components.mainBody.height,a=Math.max(30,60-10*this.phase);for(let n=0;n<t;n++)setTimeout(()=>{if(!this.active)return;const o=s+n*i,l=this.x+30*Math.cos(o+Math.PI/2),r=h+30*Math.sin(o+Math.PI/2),c=350+25*this.phase,d=new AlienProjectile(l,r,0,6,this.colors.energy);d.speedX=c*Math.cos(o+Math.PI/2);d.speedY=c*Math.sin(o+Math.PI/2);game.alienProjectiles.push(d)},n*a);AudioSystem&&AudioSystem.playSpreadSound()}missileVolley(){const e=3+Math.floor(this.phase),t=this.y+.4*this.components.mainBody.height,i=Math.max(150,250-40*this.phase);for(let s=0;s<e;s++)setTimeout(()=>{if(!this.active)return;const h=this.x+(Math.random()-.5)*.6*this.width;game.alienProjectiles.push(new AlienProjectile(h,t,220,10,this.colors.secondary,.3+.1*this.phase));AudioSystem&&AudioSystem.playHeavySound()},s*i)}mineField(){const e=4+this.phase,t=.7*this.width;for(let i=0;i<e;i++){const s=this.x+(Math.random()-.5)*t,h=this.y+.6*this.height+80*Math.random(),a=new AlienProjectile(s,h,20,12,this.colors.primary);a.speedY=20+10*Math.random();a.speedX=30*(Math.random()-.5);a.lifeTimer=5e3+2e3*Math.random();a.trackingFactor=0;a.damage=ALIEN_COLLISION_DAMAGE+3;a.update=function(n){if(!this.active)return;const o=n/1e3;this.lifeTimer-=n;if(this.lifeTimer<=0){this.explode();return}this.x+=this.speedX*o;this.y+=this.speedY*o;if(spaceship.isAlive&&!spaceship.shieldActive&&isColliding(this,spaceship)){this.explode();spaceship.takeDamage(this.damage)}if(this.y>canvas.height+this.height||this.x<-this.width||this.x>canvas.width+this.width)this.active=!1};a.explode=function(){if(!this.active)return;this.active=!1;game.explosions.push(new Explosion(this.x,this.y,60,{primary:this.color,energy:"#ffccaa"},"medium"));AudioSystem&&AudioSystem.playExplosionSound("medium")};game.alienProjectiles.push(a)}}beamCannon(){if(!this.components.core.active||!this.components.core.isHittable){console.log("WARN: Beam ma nucleo non pronto.");return}console.log("Boss spara: BEAM CANNON!");const e=1500+200*this.phase,t=25+5*this.phase,i=this.x+this.components.core.x,s=this.y+this.components.core.y+this.components.core.height/2;AudioSystem&&AudioSystem.startContinuous();const h=new Explosion(i,s,0,{type:"beam",life:e,startTime:Date.now(),colors:this.colors,width:t,dps:LASER_DPS*(1+.25*this.phase),bossRef:this});h.drawBeam=a=>{if(!h.active||!a)return;const n=Date.now()-h.startTime;if(n>=h.life){h.active=!1;AudioSystem&&AudioSystem.stopContinuous();return}const o=canvas.height-h.y,l=3*Math.sin(n*.02)*(1+.5*h.bossRef.phase),r=h.colors.width+l,c=.8*(1-n/(1.2*h.life));a.save();a.globalAlpha=Math.max(0,c);const d=a.createLinearGradient(h.x,h.y,h.x,h.y+o);try{d.addColorStop(0,h.colors.accent+"FF");d.addColorStop(.1,h.colors.energy+"EE");d.addColorStop(.7,h.colors.primary+"BB");d.addColorStop(1,h.colors.primary+"33")}catch{d.addColorStop(0,"#fff");d.addColorStop(1,h.colors.primary+"33")}a.fillStyle=d;a.fillRect(h.x-r/2,h.y,r,o);const f={x:h.x-r/2,y:h.y,width:r,height:o};spaceship.isAlive&&!spaceship.shieldActive&&isColliding(f,spaceship)&&spaceship.takeDamage(h.dps*game.deltaTime/1e3);a.restore()};game.explosions.push(h)}summonReinforcements(){const e=1+this.phase;console.log(`Boss evoca ${e} guardie elite`);for(let t=0;t<e;t++){const i=this.x+(t%2==0?-1:1)*(.6*this.width+30*Math.random()),s=this.y-50,h={health:3*(1+.5*this.phase),speedY:100+10*this.phase,shootCooldown:Math.max(800,1900-300*this.phase),movement:"sine",speedFactor:1.1,sineAmplitude:80+20*Math.random(),sineFrequency:.022+Math.random()*.005-.0025,isElite:!0},a=window.alienColorSchemes[3];game.aliens.push(new Alien(i,s,30,a,h.movement,h))}}updateTotalHealth(){if(!bossHealthBar||!bossHealthText)return;this.currentTotalHealth=Object.values(this.components).filter(e=>e.isHittable&&e.active).reduce((e,t)=>e+Math.max(0,t.health),0);this.components.core.isHittable&&this.components.core.active&&(this.currentTotalHealth+=Math.max(0,this.components.core.health));let e=Object.values(this.components).filter(t=>t.isHittable&&t.active).reduce((t,i)=>t+i.maxHealth,0);this.components.core.isHittable&&this.components.core.active&&(e+=this.components.core.maxHealth);0===e&&(e=this.totalMaxHealth);const t=this.totalMaxHealth>0?Math.max(0,this.currentTotalHealth)/this.totalMaxHealth:0;bossHealthBar.style.width=`${100*t}%`;bossHealthText.textContent=`CMDR SCUDERI (${Math.round(100*t)}%)`}determinePhase(){const e=this.components.shieldGenerator,t=this.components.leftTurret,i=this.components.rightTurret,s=this.components.core;let h=0;if(!e.active&&(h=1,!t.active&&!i.active&&(h=2,!s.active&&!s.isHittable))){console.log("NUCLEO ESPOSTO!");s.active=!0;s.isHittable=!0;this.totalMaxHealth=Object.values(this.components).filter(a=>a.maxHealth<9e3).reduce((a,n)=>a+n.maxHealth,0);this.updateTotalHealth();game.uiMessage="NUCLEO ESPOSTO!";game.uiMessageTimer=2500;if(uiMessageDisplay){uiMessageDisplay.style.color="#ff8888";uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add("visible")}}this.phase=h}takeDamage(e,t,i){if(!this.active||this.isEntering)return;let s=null,h=1;const a=this.components.shieldGenerator;if(a.active&&a.shieldActive){const n=t-(this.x+a.x),o=i-(this.y+a.y);if(n*n+o*o<a.shieldRadius*a.shieldRadius){s=a;h=.7;game.explosions.push(new Explosion(t,i,20,{primary:this.colors.shield,energy:"#fff"},"small"));AudioSystem.playShieldDownSound()}}if(!s)for(const n in this.components){const o=this.components[n];if(!o.active||!o.isHittable||o===a)continue;const l=this.x+o.x-o.width/2,r=this.y+o.y-o.height/2,c=l+o.width,d=r+o.height;if(t>=l&&t<=c&&i>=r&&i<=d){s=o;h=1;break}}if(s){const f=e*h;s.health-=f;game.explosions.push(new Explosion(t,i,15,{primary:"#fff",energy:"#ffccaa"},"small"));if(s.health<=0&&s.active){s.health=0;s.active=!1;console.log(`Boss: ${s.name} distrutto!`);game.explosions.push(new Explosion(this.x+s.x,this.y+s.y,1.5*s.width,this.colors,"medium"));AudioSystem.playExplosionSound("medium");if(s===a){a.shieldActive=!1;console.log("Boss: SCUDO OFF!");game.uiMessage="SCUDO DISTRUTTO!";game.uiMessageTimer=2e3;if(uiMessageDisplay){uiMessageDisplay.style.color="#ffff88";uiMessageDisplay.textContent=game.uiMessage;uiMessageDisplay.classList.add("visible")}}else if(s===this.components.core){this.defeat();return}this.determinePhase()}this.updateTotalHealth()}}defeat(){if(!this.active)return;this.active=!1;this.isVisible=!1;game.bossSpawned=!1;game.bossDefeated=!0;console.log("BOSS SCONFITTO!");game.score+=15e3;bossHealthBarContainer&&(bossHealthBarContainer.style.display="none");createBossExplosion(this.x,this.y,1.5*this.width);AudioSystem&&(AudioSystem.playMegaExplosionSound(),AudioSystem.stopAllMP3Music(1e3));setTimeout(()=>{game.isGameOver||gameOver(!0)},5500)}drawMainBody(e){if(!e||!this.components.mainBody.active)return;const t=this.components.mainBody;e.save();e.translate(this.x+t.x,this.y+t.y);const i=e.createLinearGradient(0,-.5*t.height,0,.5*t.height);i.addColorStop(0,this.colors.secondary);i.addColorStop(.5,this.colors.primary);i.addColorStop(1,"#400");e.fillStyle=i;e.beginPath();e.moveTo(0,-.5*t.height);e.bezierCurveTo(.4*t.width,-.55*t.height,.45*t.width,-.1*t.height,.5*t.width,0);e.bezierCurveTo(.48*t.width,.3*t.height,.2*t.width,.45*t.height,0,.5*t.height);e.bezierCurveTo(-.2*t.width,.45*t.height,-.48*t.width,.3*t.height,-.5*t.width,0);e.bezierCurveTo(-.45*t.width,-.1*t.height,-.4*t.width,-.55*t.height,0,-.5*t.height);e.closePath();e.fill();e.strokeStyle=this.colors.glow;e.lineWidth=1.5;e.stroke();this.phaseChangeFlash>0&&Math.floor(this.phaseChangeFlash/50)%2==0&&(e.fillStyle="rgba(255,255,255,0.5)",e.fill());e.restore()}drawTurret(e,t){if(!t)return;const i=-1===e?this.components.leftTurret:this.components.rightTurret;if(t.save(),t.translate(this.x+i.x,this.y+i.y),!i.active){t.fillStyle="#333";t.strokeStyle="#666";t.lineWidth=2;t.beginPath();t.arc(0,0,.3*i.width,0,2*Math.PI);t.fill();t.stroke();for(let s=0;s<3;s++){t.beginPath();t.moveTo(0,0);const h=2*Math.random()*Math.PI;t.lineTo(Math.cos(h)*.3*i.width,Math.sin(h)*.3*i.width);t.stroke()}t.restore();return}const s=.8*i.width,h=.4*s,a=.1*h*Math.sin(game.animationFrame*.1+e*5),n=t.createRadialGradient(0,0,h,0,0,.8*s);try{n.addColorStop(0,hexToRgba(this.colors.energy,1));n.addColorStop(.6,hexToRgba(this.colors.glow,.53));n.addColorStop(1,hexToRgba(this.colors.glow,0))}catch{n.addColorStop(0,this.colors.energy);n.addColorStop(1,this.colors.glow+"00")}t.fillStyle=n;t.beginPath();t.arc(0,0,.8*s,0,2*Math.PI);t.fill();t.fillStyle="#111";t.beginPath();t.arc(0,0,.5*s,0,2*Math.PI);t.fill();t.fillStyle=this.colors.primary;t.beginPath();t.arc(0,0,h+a,0,2*Math.PI);t.fill();try{t.fillStyle=hexToRgba(this.colors.accent,.6)}catch{t.fillStyle=this.colors.accent+"99"}t.beginPath();t.arc(.15*s,-.15*s,.2*h,0,2*Math.PI);t.fill();if(i.active){const o=i.health/i.maxHealth,l=.06*i.width,r=i.width,c=.55*i.height;t.fillStyle="rgba(50,0,0,0.7)";t.fillRect(-r/2,c,r,l);t.fillStyle=o>.5?"#f44":o>.2?"#f84":"#f00";t.fillRect(-r/2,c,r*o,l)}t.restore()}drawShieldGenerator(e){if(!e)return;const t=this.components.shieldGenerator;if(e.save(),e.translate(this.x+t.x,this.y+t.y),!t.active){e.fillStyle="#444";e.strokeStyle="#888";e.lineWidth=1;e.strokeRect(-t.width/2,-t.height/2,t.width,t.height);e.beginPath();e.moveTo(-.4*t.width,-.3*t.height);e.lineTo(.4*t.width,.3*t.height);e.stroke();e.beginPath();e.moveTo(.4*t.width,-.3*t.height);e.lineTo(-.4*t.width,.3*t.height);e.stroke();e.restore();return}const i=6,s=2*Math.PI/i,h=.45*t.width,a=.5*h;e.fillStyle=t.shieldActive?this.colors.shield:"#668888";e.strokeStyle="#fff";e.lineWidth=1;e.beginPath();for(let n=0;n<i;n++)e.lineTo(Math.cos(s*n)*h,Math.sin(s*n)*h),e.lineTo(Math.cos(s*n+s/2)*a,Math.sin(s*n+s/2)*a);e.closePath();e.fill();e.stroke();if(t.shieldActive){e.save();e.translate(-t.x,-t.y);e.globalAlpha=.3+.1*Math.sin(game.animationFrame*.05);const o=e.createRadialGradient(0,0,.1*t.shieldRadius,0,0,t.shieldRadius+t.shieldPulse);try{o.addColorStop(0,hexToRgba(this.colors.shield,.07));o.addColorStop(.8,hexToRgba(this.colors.shield,.4));o.addColorStop(1,hexToRgba(this.colors.shield,.07))}catch{o.addColorStop(.8,this.colors.shield+"66");o.addColorStop(1,this.colors.shield+"11")}e.fillStyle=o;e.beginPath();e.arc(0,0,t.shieldRadius+t.shieldPulse,0,2*Math.PI);e.fill();e.restore()}e.restore()}drawCore(e){if(!e||!this.components.core.active)return;const t=this.components.core;e.save();e.translate(this.x+t.x,this.y+t.y);const i=.9+.1*Math.sin(game.animationFrame*.1),s=t.width*i,h=t.height*i,a=e.createRadialGradient(0,0,0,0,0,.7*s);a.addColorStop(0,this.colors.accent+"CC");a.addColorStop(.5,this.colors.energy+"AA");a.addColorStop(1,this.colors.primary+"00");e.fillStyle=a;e.fillRect(-s/2,-h/2,s,h);try{e.fillStyle=hexToRgba(this.colors.accent,.6+.2*Math.sin(game.animationFrame*.15))}catch{e.fillStyle=`rgba(255,200,200,${.6+.2*Math.sin(game.animationFrame*.15)})`}e.fillRect(-.4*s,-.4*h,.8*s,.8*h);if(t.isHittable){const n=t.health/t.maxHealth,o=1.2*t.width,l=8,r=.6*t.height;e.fillStyle="rgba(50,0,0,0.8)";e.fillRect(-o/2,r,o,l);e.fillStyle=n>.5?"#f44":n>.2?"#f84":"#f00";e.fillRect(-o/2,r,o*n,l)}e.restore()}draw(e){if(!this.active||!this.isVisible||!e)return;this.components.mainBody.draw(e);this.components.leftTurret.draw(e);this.components.rightTurret.draw(e);this.components.shieldGenerator.draw(e);this.components.core.draw(e)}}

    // --- Funzioni Logica Cristalli (Esagonali) ---
    function createCrystalCollectEffect(x,y,color){const eC={primary:color.primary,secondary:color.secondary,accent:"#ffffff",glow:color.glow,energy:color.highlight};game.explosions.push(new Explosion(x,y,25,eC,"small"));}
    function playCrystalCollectSound(type){AudioSystem.playCrystalSound(type);}
    function spawnCrystalsFromAlien(alien){let count=0;let types=[];const pwr=alien.size*alien.maxHealth;if(pwr<70){if(Math.random()<0.35){count=1;types=[0];}}else if(pwr<150){const r=Math.random();if(r<0.5){count=1;types=[0];}else if(r<0.7){count=1;types=[1];}}else if(pwr<300){const r=Math.random();if(r<0.3){count=1;types=[1];}else if(r<0.6){count=2;types=[0,0];}else if(r<0.8){count=1;types=[2];}}else{const r=Math.random();if(r<0.3){count=2;types=[1,0];}else if(r<0.6){count=1;types=[2];}else if(r<0.85){count=2;types=[1,1];}else{count=1;types=[3];}}if(alien.isElite&&Math.random()<0.5){count++;types.push(Math.floor(Math.random()*2));}if(!game.crystals)game.crystals=[];for(let i=0;i<count;i++){const oX=(Math.random()-0.5)*alien.size*0.5;const oY=(Math.random()-0.5)*alien.size*0.5;game.crystals.push(new Crystal(alien.x+oX,alien.y+oY,types[i]??0));}}
    function initCrystalSystem(){console.log("Inizializzazione cristalli...");if(!game.crystals)game.crystals=[];const origTakeDamage=Alien.prototype.takeDamage;if(origTakeDamage&&!origTakeDamage.isPatchedForCrystals){Alien.prototype.takeDamage=function(amount){const destroyed=origTakeDamage.call(this,amount);if(destroyed&&typeof spawnCrystalsFromAlien==='function')spawnCrystalsFromAlien(this);return destroyed;};Alien.prototype.takeDamage.isPatchedForCrystals=true;}console.log("Sistema cristalli pronto.");}
    function updateCrystals(deltaTime){if(!game.crystals)return;for(let i=game.crystals.length-1;i>=0;i--){game.crystals[i].update(deltaTime,spaceship);if(!game.crystals[i].active)game.crystals.splice(i,1);}}
    // drawCrystals è già nel Blocco 6 (funzioni di disegno)

    // --- Funzioni Gestione Stato Gioco, Loop, etc. ---
    function initializeGame(){console.log("INFO: Inizializzazione gioco post-registrazione...");if(!assignElements())return;AudioSystem.init(()=>{});window.addEventListener('keydown',handleKeyDown);window.addEventListener('keyup',handleKeyUp);canvas.addEventListener('contextmenu',(e)=>e.preventDefault());setupButtonListeners();loadHighScores();displayHighScores();initCrystalSystem();resetGame();createStars();createInitialPlanets();updateGameUI(game,spaceship);if(titleLogoCanvas)drawCondorspaceTitleLogo(titleLogoCanvas);mainLayout.classList.add('visible');startButton.style.display='block';startButton.disabled=false;canvas.focus();console.log("INFO: Init gioco completato.");}
    function startGame(isRestart=false){console.log("INFO: Avvio partita...");if(game.running&&!game.paused&&!isRestart)return;AudioSystem.playButtonSound();gameOverOverlay.style.display='none';startButton.style.display='none';pauseOverlay.classList.remove('visible');resetGame();AudioSystem.playGameStartSound();if(AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){AudioSystem.stopAllMP3Music(isRestart?0:200);setTimeout(()=>{if(game.running&&!game.paused&&!game.bossSpawned)AudioSystem.playGameplayMP3();},isRestart?50:300);}game.running=true;game.paused=false;game.isGameOver=false;game.lastTime=performance.now();if(animationFrameId===null){gameLoop(game.lastTime);console.log("INFO: Game loop avviato.");}else{console.log("INFO: Gioco ripreso.");}canvas.focus();}
    function resetGame(){console.log("INFO: Reset gioco.");game.score=0;game.lives=3;game.level=1;game.currentWaveIndex=-1;game.waveTimer=0;game.timeUntilNextWave=3000;game.inWavePause=true;game.allWavesCompleted=false;game.bossSpawned=false;game.bossDefeated=false;game.alienSpawnTimer=0;game.errorNotified=false;game.playerProjectiles=[];game.aliens=[];game.alienProjectiles=[];game.explosions=[];game.powerUps=[];game.crystals=[];game.currentScoreSubmitted=false;spaceship.x=canvas.width/2-spaceship.width/2;spaceship.y=canvas.height-spaceship.height-20;spaceship.health=spaceship.maxHealth;spaceship.weaponType=0;spaceship.isAlive=true;spaceship.shieldActive=false;spaceship.shieldTimer=0;spaceship.invincibleAfterHit=false;spaceship.invincibleAfterLifeLoss=false;spaceship.hitInvincibleTimer=0;spaceship.lifeLossInvincibleTimer=0;spaceship.laserBeamActive=false;if(AudioSystem)AudioSystem.stopContinuous();gameBoss=null;updateGameUI(game,spaceship);if(bossHealthBarContainer)bossHealthBarContainer.style.display='none';}
    function pauseGame(){if(!game.paused&&game.running&&!game.isGameOver){game.paused=true;if(AudioSystem)AudioSystem.stopContinuous();console.log("PAUSA");pauseOverlay.classList.add('visible');}}
    function resumeGame(){if(game.paused&&game.running&&!game.isGameOver){game.paused=false;pauseOverlay.classList.remove('visible');AudioSystem.resumeContext(()=>{if(game.bossSpawned&&!game.bossDefeated){/* La musica boss procedurale viene gestita separatamente */}else if(game.running&&!game.allWavesCompleted)AudioSystem.playGameplayMP3();if(spaceship.firing&&spaceship.weaponType===4&&spaceship.isAlive)AudioSystem.startContinuous();});game.lastTime=performance.now();if(!animationFrameId)gameLoop(game.lastTime);console.log("RIPRESA");canvas.focus();}}
    function togglePause(){if(!game.running||game.isGameOver)return;if(game.paused)resumeGame();else pauseGame();}
    function gameOver(victory=false){if(game.isGameOver)return;console.log(`Game Over. Vittoria: ${victory}`);game.isGameOver=true;game.running=false;if(animationFrameId!==null){cancelAnimationFrame(animationFrameId);animationFrameId=null;}if(AudioSystem){if(!victory)AudioSystem.playGameOverSound();AudioSystem.stopContinuous();AudioSystem.stopAllMP3Music(game.bossDefeated&&victory?4500:500);AudioSystem.stopProceduralBossMusic();}finalScoreUI.textContent=game.score;gameOverOverlay.style.display='flex';gameOverOverlay.classList.toggle('victory',victory);gameOverOverlay.querySelector('h2').textContent=victory?"VITTORIA!":"FINE PARTITA";const scores=loadHighScores();const lowestScore=scores.length<MAX_HIGH_SCORES?0:scores[scores.length-1].score;if(game.score>lowestScore){console.log("Nuovo High Score!");highScoreEntryUI.style.display='block';playerNameInput.value='';playerNameInput.focus();game.currentScoreSubmitted=false;saveScoreButton.style.display='block';restartButton.style.display='none';const label=highScoreEntryUI.querySelector('label');if(label){if(victory||game.bossDefeated){label.innerHTML='Vittoria Eroica! Nuovo Record! <span title="CMDR Scuderi Sconfitto!">🏆</span>';}else{label.textContent='Congratulazioni! Nuovo Record!';}}}else{highScoreEntryUI.style.display='none';restartButton.style.display='block';saveScoreButton.style.display='none';game.currentScoreSubmitted=true;}}
    function loseLife(){if(!spaceship.isAlive)return;console.log("Vita persa!");game.lives--;updateGameUI(game,spaceship);game.explosions.push(new Explosion(spaceship.x+spaceship.width/2,spaceship.y+spaceship.height/2,spaceship.width*1.5,{primary:'#ffaa44',secondary:'#ff8800',accent:'#ffffff',glow:'#ff6600',energy:'#ffff88'},'medium'));if(AudioSystem)AudioSystem.playExplosionSound('medium');spaceship.isAlive=false;if(game.lives<=0){setTimeout(()=>gameOver(false),1000);}else{setTimeout(()=>{if(!game.running||game.isGameOver)return;spaceship.x=canvas.width/2-spaceship.width/2;spaceship.y=canvas.height-spaceship.height-20;spaceship.health=spaceship.maxHealth;spaceship.isAlive=true;spaceship.invincibleAfterLifeLoss=true;spaceship.lifeLossInvincibleTimer=spaceship.LIFE_LOSS_INVINCIBILITY_DURATION;spaceship.weaponType=0;spaceship.laserBeamActive=false;if(AudioSystem)AudioSystem.stopContinuous();console.log("Respawn.");updateGameUI(game,spaceship);},2000);}}

    function updateWaveSystem(deltaTime){if(game.bossSpawned||game.isGameOver)return;if(game.allWavesCompleted&&!game.inWavePause){if(game.aliens.filter(a=>a.active).length===0){if(!gameBoss&&!game.bossSpawned){console.log("Onde finite, alieni clear. Countdown Boss...");warningBeforeBoss();game.timeUntilNextWave=4000;game.allWavesCompleted=false;game.inWavePause=true;}}return;}if(game.inWavePause){game.timeUntilNextWave-=deltaTime;if(game.timeUntilNextWave<=0){if(game.allWavesCompleted&&!game.bossSpawned){spawnBoss();game.inWavePause=false;}else if(!game.allWavesCompleted){startNextWave();}}}else{const wave=WAVES[game.currentWaveIndex];if(!wave)return;game.waveTimer+=deltaTime;game.alienSpawnTimer-=deltaTime;if(game.waveTimer>=wave.duration&&!game.allWavesCompleted){console.log(`Onda ${game.currentWaveIndex+1} durata terminata.`);game.inWavePause=true;game.timeUntilNextWave=wave.pauseAfter||3000;game.alienSpawnTimer=0;updateGameUI(game,spaceship);return;}if(game.alienSpawnTimer<=0&&game.aliens.filter(a=>a.active).length<wave.maxAliensOnScreen){spawnAlien(wave);game.alienSpawnTimer=wave.spawnInterval*(0.85+Math.random()*0.25);}}}
    function startNextWave(){game.currentWaveIndex++;if(game.currentWaveIndex>=WAVES.length){console.log("Tutte le onde finite! Attesa Boss...");game.allWavesCompleted=true;game.inWavePause=true;game.timeUntilNextWave=5000;warningBeforeBoss();}else{const wave=WAVES[game.currentWaveIndex];console.log(`Avvio Onda ${game.currentWaveIndex+1}: ${wave.name}`);game.waveTimer=0;game.timeUntilNextWave=0;game.inWavePause=false;game.level=game.currentWaveIndex+1;game.alienSpawnTimer=wave.spawnInterval*0.5;}updateGameUI(game,spaceship);}
    function warningBeforeBoss(){console.log("Warning: Boss incoming!");let f=0;const mF=5;const fId=setInterval(()=>{if(f>=mF||game.isGameOver||game.bossSpawned){clearInterval(fId);if(canvas)canvas.style.borderColor="#303050";return;}if(canvas)canvas.style.borderColor=f%2===0?"#ff4444":"#303050";game.screenFlashTimer=SCREEN_FLASH_DURATION;f++;if(f===1){game.uiMessage="⚠️ BOSS IN ARRIVO ⚠️";game.uiMessageTimer=UI_MESSAGE_DURATION*2.5;if(uiMessageDisplay)uiMessageDisplay.style.color="#ff4444";AudioSystem.stopAllMP3Music(1000);}},600);}

    function checkCollisions(deltaTime){const dtS=deltaTime/1000;for(let i=game.playerProjectiles.length-1;i>=0;i--){const p=game.playerProjectiles[i];if(!p.active)continue;for(let j=game.aliens.length-1;j>=0;j--){const a=game.aliens[j];if(!a.active)continue;if(isColliding(p,a)){p.active=false;a.takeDamage(p.damage);break;}}}if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){for(let i=game.playerProjectiles.length-1;i>=0;i--){const p=game.playerProjectiles[i];if(!p.active)continue;const bR={x:gameBoss.x-gameBoss.width/2,y:gameBoss.y-gameBoss.height/2,width:gameBoss.width,height:gameBoss.height};if(isColliding(p,bR)){gameBoss.takeDamage(p.damage,p.x+p.width/2,p.y+p.height/2);p.active=false;}}}if(spaceship.laserBeamActive&&spaceship.isAlive&&isSpaceshipCurrentlyVisible()){const lW=12;const lR={x:spaceship.x+spaceship.width/2-lW/2,y:0,width:lW,height:spaceship.y};game.aliens.forEach(a=>{if(a.active&&isColliding(lR,{x:a.x-a.collisionRadius,y:a.y-a.collisionRadius,width:a.collisionRadius*2,height:a.collisionRadius*2})){a.takeDamage(LASER_DPS*dtS);if(game.animationFrame%5===0)a.hitEffects.push({x:(Math.random()-.5)*a.size*.3,y:(Math.random()-.5)*a.size*.3,size:a.size*.2,life:0.5});}});if(gameBoss&&gameBoss.active&&!gameBoss.isEntering){for(const k in gameBoss.components){const c=gameBoss.components[k];if(!c.active||!c.isHittable)continue;const cR={x:gameBoss.x+c.x-c.width/2,y:gameBoss.y+c.y-c.height/2,width:c.width,height:c.height};if(isColliding(lR,cR)){const hX=spaceship.x+spaceship.width/2;const hY=Math.max(cR.y,lR.y);gameBoss.takeDamage(LASER_DPS*dtS,hX,hY);}}}}if(spaceship.isAlive&&!spaceship.shieldActive&&!spaceship.invincibleAfterHit&&!spaceship.invincibleAfterLifeLoss){for(let i=game.alienProjectiles.length-1;i>=0;i--){const ap=game.alienProjectiles[i];if(ap.active&&ap.lifeTimer===null&&isColliding(ap,spaceship)){ap.active=false;spaceship.takeDamage(ap.damage);}}}else if(spaceship.isAlive&&spaceship.shieldActive){const sR=spaceship.width*0.8;const sCX=spaceship.x+spaceship.width/2;const sCY=spaceship.y+spaceship.height/2;for(let i=game.alienProjectiles.length-1;i>=0;i--){const ap=game.alienProjectiles[i];if(!ap.active)continue;const dx=ap.x+ap.width/2-sCX;const dy=ap.y+ap.height/2-sCY;const dSq=dx*dx+dy*dy;if(dSq<(sR+ap.width/2)**2){ap.active=false;game.explosions.push(new Explosion(ap.x,ap.y,15,{primary:"#fff",energy:"#80ffff"},'small'));}}}}

    function gameLoop(currentTime){if(!ctx||!canvas||!game||!spaceship){console.error("ERRORE CRITICO: Oggetti essenziali mancanti nel game loop.");if(animationFrameId){cancelAnimationFrame(animationFrameId);animationFrameId=null;}return;}try{if(!game.running){if(animationFrameId)cancelAnimationFrame(animationFrameId);animationFrameId=null;return;}if(game.paused){animationFrameId=requestAnimationFrame(gameLoop);return;}if(!game.lastTime)game.lastTime=currentTime;game.deltaTime=currentTime-game.lastTime;game.lastTime=currentTime;if(game.deltaTime>100)game.deltaTime=16.67;game.animationFrame++;if(game.globalAlienFireCooldown>0)game.globalAlienFireCooldown-=game.deltaTime;if(game.screenFlashTimer>0)game.screenFlashTimer-=game.deltaTime;updateUIState(game.deltaTime);updateStars(game.stars,starSpeed,canvas.height,game.deltaTime);updatePlanets(game.planets,game.deltaTime);updateSpaceship(game.deltaTime);updateProjectiles(game.playerProjectiles,game.deltaTime);updateAliens(game.deltaTime);updateProjectiles(game.alienProjectiles,game.deltaTime);updatePowerUps(game.deltaTime);updateCrystals(game.deltaTime);updateExplosions(game.deltaTime);updateBoss(gameBoss,game.deltaTime);updateWaveSystem(game.deltaTime);checkCollisions(game.deltaTime);ctx.clearRect(0,0,canvas.width,canvas.height);drawBackground();drawCrystals(ctx);drawPowerUps();drawAliens();drawProjectiles(game.alienProjectiles);drawSpaceship();drawLaserBeam();drawProjectiles(game.playerProjectiles);if(gameBoss&&gameBoss.isVisible)gameBoss.draw(ctx);drawExplosions();drawUIEffects();drawBossHealth();updateGameUI(game,spaceship);animationFrameId=requestAnimationFrame(gameLoop);}catch(error){console.error("ERRORE FATALE nel game loop:",error);game.running=false;if(ctx&&canvas){try{ctx.fillStyle="rgba(0,0,0,0.85)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#ff4444";ctx.font="bold 22px VT323";ctx.textAlign="center";ctx.fillText("ERRORE DI SISTEMA!",canvas.width/2,canvas.height/2-20);ctx.font="16px VT323";ctx.fillStyle="#ffaaaa";ctx.fillText("Si è verificato un errore critico.",canvas.width/2,canvas.height/2+10);ctx.fillText("Ricarica la pagina (F5) o consulta la console (F12).",canvas.width/2,canvas.height/2+35);}catch(e2){console.error("Errore nel disegnare il messaggio di errore:",e2);}}if(animationFrameId){cancelAnimationFrame(animationFrameId);animationFrameId=null;}}}

    // --- Funzioni Intro e Flusso Iniziale ---
    function startIntroSequence(){console.log("Starting Intro...");if(!introOverlay||!mainLayout||!skipIntroButton||!introLogoCanvas){console.error("Intro elements missing.");return;}window.introOver=false;window.introAudioPlayed=false;introOverlay.style.opacity='1';introOverlay.classList.remove('hidden');introOverlay.style.display='flex';drawCondorspaceTitleLogo(introLogoCanvas);mainLayout.classList.remove('visible');if(startButton)startButton.style.display="none";if(gameOverOverlay)gameOverOverlay.style.display="none";skipIntroButton.removeEventListener('click',handleSkipInteraction);window.removeEventListener('keydown',handleIntroSkipKey);skipIntroButton.addEventListener('click',handleSkipInteraction);window.addEventListener('keydown',handleIntroSkipKey);const introDuration=60000;if(window.introTimeout)clearTimeout(window.introTimeout);window.introTimeout=setTimeout(()=>{if(!window.introOver)handleSkipInteraction();},introDuration);if(AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){console.log("Playing intro music immediately.");AudioSystem.playIntroMP3();window.introAudioPlayed=true;}else{console.log("Audio context suspended, intro music will wait.");}const crawlC=document.getElementById('crawlContainer');if(crawlC)setTimeout(()=>{crawlC.style.opacity='1';},5000);}
    function handleSkipInteraction(){if(window.introOver)return;console.log("Intro interaction.");AudioSystem.playButtonSound();AudioSystem.resumeContext(()=>{if(!window.introAudioPlayed&&AudioSystem.isInitialized&&AudioSystem.context?.state==='running'){console.log("Audio context running after interaction, playing intro music.");AudioSystem.playIntroMP3();window.introAudioPlayed=true;}skipIntroVisuals();});}
    function skipIntroVisuals(){if(window.introOver)return;window.introOver=true;console.log("Ending Intro Visuals...");if(window.introTimeout)clearTimeout(window.introTimeout);window.introTimeout=null;const skipBtn=document.getElementById('skipIntroButton');if(skipBtn)skipBtn.removeEventListener('click',handleSkipInteraction);window.removeEventListener('keydown',handleIntroSkipKey);if(introOverlay){introOverlay.style.opacity='0';introOverlay.classList.add('hidden');}setTimeout(()=>{if(introOverlay)introOverlay.style.display='none';showCadetRegistration();},1000);}
    function handleIntroSkipKey(e){const pNI=document.getElementById('playerNameInput');if(e.key===" "&&!window.introOver&&(!pNI||document.activeElement!==pNI)){e.preventDefault();handleSkipInteraction();}}

    // --- Funzioni Registrazione Cadetto ---
    function showCadetRegistration(){console.log("Mostra registrazione cadetto...");const screen=document.getElementById('cadetRegistrationScreen');if(screen){screen.classList.add('active');if(typeof renderCadetRegistration==='function')renderCadetRegistration();else{console.error("renderCadetRegistration non definita");completeCadetRegistration("CADETTO");}}else{console.error("Schermata registrazione non trovata!");completeCadetRegistration("CADETTO");}}
    function completeCadetRegistration(cadetName){const screen=document.getElementById('cadetRegistrationScreen');const layout=document.getElementById('mainLayout');const btn=document.getElementById('startButton');if(screen)screen.classList.remove('active');if(layout)layout.classList.add('visible');if(btn){btn.style.display='block';btn.disabled=false;btn.focus();}console.log("Registrazione completata:",cadetName);if(window.game)game.cadetName=cadetName;updateCadetNameInUI(cadetName);const sub=document.querySelector('#titleHeader h2');if(sub)sub.textContent="NETHEX CONTRO IL DEMAND GALATTICO"; /*AudioSystem.stopAllMP3Music(); Rimosso, la musica intro continua */}
    function updateCadetNameInUI(cadetName){const sidebar=document.getElementById('uiSidebar');if(!sidebar)return;let container=document.getElementById('cadetNameContainer');if(!container){container=document.createElement('div');container.id='cadetNameContainer';container.style.marginTop='15px';container.style.marginBottom='15px';container.style.textAlign='center';container.style.padding='8px 0';container.style.borderTop='1px solid #445566';container.style.borderBottom='1px solid #445566';container.style.backgroundColor='rgba(0,0,0,0.15)';container.innerHTML=`<div style="color:#aaccff;font-size:0.9em;margin-bottom:3px;text-transform:uppercase;letter-spacing:1px;">PILOTA</div><div id="cadetNameDisplay" style="color:#ffaa44;font-weight:bold;font-size:1.1em;text-shadow:0 0 4px #ffaa44;">${cadetName}</div><div style="color:#aaccff;font-size:0.8em;margin-top:3px;font-style:italic;">STATO MISSIONE</div>`;const header=sidebar.querySelector('h3');if(header)header.after(container);else sidebar.prepend(container);}else{const display=document.getElementById('cadetNameDisplay');if(display)display.textContent=cadetName;}}
    function renderCadetRegistration(){console.log("Rendering cadet registration UI...");const container=document.getElementById('cadetRegistrationContainer');if(!container){console.error("Container registrazione cadetto non trovato");return;}let cadetName='';let isSubmitting=false;container.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;background:#0f0f1e;padding:20px;border-radius:10px;border:1px solid #49daff;box-shadow:0 0 30px rgba(73,218,255,0.4);"><canvas id="cadetCanvas" width="500" height="300" style="margin-bottom:20px;border-radius:5px;"></canvas><div style="display:flex;align-items:center;width:80%;margin-bottom:20px;"><input type="text" id="cadetNameInputReg" placeholder="Inserisci il tuo nome, Cadetto" style="flex:1;padding:10px;background:#0a0a2a;color:#49daff;border:2px solid #49daff;border-radius:4px;font-size:16px;font-family:'VT323',monospace;" maxlength="10" minlength="3"><button id="submitCadetButton" style="margin-left:10px;padding:10px 20px;background:#49daff;color:#000;border:none;border-radius:4px;font-weight:normal;cursor:pointer;font-family:'VT323',monospace;text-transform:uppercase;letter-spacing:1px;" disabled>CONFERMA</button></div><p style="color:#bbb;font-size:14px;text-align:center;line-height:1.4;">Identificati, pilota.<br>Il tuo nome verrà inciso negli annali del Demand.</p></div>`;drawCadetRegistrationCanvas();const inputField=document.getElementById('cadetNameInputReg');const confirmButton=document.getElementById('submitCadetButton');if(!inputField||!confirmButton){console.error("Elementi UI registrazione mancanti");return;}const updateSubmitState=()=>{if(isSubmitting){confirmButton.disabled=true;confirmButton.textContent='REGISTRAZIONE...';confirmButton.style.background='#274b5d';confirmButton.style.color='#aaa';confirmButton.style.cursor='wait';}else if(cadetName.length<3){confirmButton.disabled=true;confirmButton.textContent='CONFERMA';confirmButton.style.background='#274b5d';confirmButton.style.color='#aaa';confirmButton.style.cursor='not-allowed';}else{confirmButton.disabled=false;confirmButton.textContent='CONFERMA';confirmButton.style.background='#49daff';confirmButton.style.color='#000';confirmButton.style.cursor='pointer';}};const handleCadetSubmit=()=>{if(cadetName.length<3||isSubmitting)return;console.log("Invio registrazione:",cadetName);isSubmitting=true;updateSubmitState();AudioSystem.playButtonSound();AudioSystem.play('gameStart');setTimeout(()=>{isSubmitting=false;updateSubmitState();completeCadetRegistration(cadetName);},1000);};inputField.addEventListener('input',(e)=>{cadetName=e.target.value.trim().toUpperCase();e.target.value=cadetName;updateSubmitState();});inputField.addEventListener('keyup',(e)=>{if(e.key==='Enter'&&!isSubmitting&&cadetName.length>=3)handleCadetSubmit();});confirmButton.addEventListener('click',handleCadetSubmit);updateSubmitState();setTimeout(()=>{if(inputField)inputField.focus();},100);}
    function drawCadetRegistrationCanvas(){const canvasReg=document.getElementById('cadetCanvas');if(!canvasReg)return;const ctxReg=canvasReg.getContext('2d');if(!ctxReg)return;const w=canvasReg.width;const h=canvasReg.height;const bgG=ctxReg.createLinearGradient(0,0,0,h);bgG.addColorStop(0,'#0c1445');bgG.addColorStop(1,'#0a0a20');ctxReg.fillStyle=bgG;ctxReg.fillRect(0,0,w,h);for(let i=0;i<150;i++){const x=Math.random()*w;const y=Math.random()*h;const r=Math.random()*1.5;const o=Math.random()*0.8+0.2;ctxReg.beginPath();ctxReg.arc(x,y,r,0,Math.PI*2);ctxReg.fillStyle=`rgba(255,255,255,${o})`;ctxReg.fill();}ctxReg.strokeStyle='#49daff';ctxReg.lineWidth=3;ctxReg.shadowColor='#49daff';ctxReg.shadowBlur=10;ctxReg.strokeRect(20,20,w-40,h-40);ctxReg.shadowBlur=0;ctxReg.lineWidth=5;const cs=20;ctxReg.beginPath();ctxReg.moveTo(20,40);ctxReg.lineTo(20,20);ctxReg.lineTo(40,20);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(w-40,20);ctxReg.lineTo(w-20,20);ctxReg.lineTo(w-20,40);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(20,h-40);ctxReg.lineTo(20,h-20);ctxReg.lineTo(40,h-20);ctxReg.stroke();ctxReg.beginPath();ctxReg.moveTo(w-40,h-20);ctxReg.lineTo(w-20,h-20);ctxReg.lineTo(w-20,h-40);ctxReg.stroke();ctxReg.shadowColor='#49daff';ctxReg.shadowBlur=5;ctxReg.font='bold 24px VT323';ctxReg.fillStyle='#49daff';ctxReg.textAlign='center';ctxReg.fillText('REGISTRAZIONE NUOVA RECLUTA',w/2,60);ctxReg.shadowBlur=0;drawCondorspaceTitleLogo({getContext:()=>ctxReg,width:150,height:75,getBoundingClientRect:()=>({width:150,height:75})});}
    function initCrystalSystem(){console.log("Inizializzazione cristalli...");if(!game.crystals)game.crystals=[];const origTakeDamage=Alien.prototype.takeDamage;if(origTakeDamage&&!origTakeDamage.isPatchedForCrystals){Alien.prototype.takeDamage=function(amount){const destroyed=origTakeDamage.call(this,amount);if(destroyed&&typeof spawnCrystalsFromAlien==='function')spawnCrystalsFromAlien(this);return destroyed;};Alien.prototype.takeDamage.isPatchedForCrystals=true;}console.log("Sistema cristalli pronto.");}

    // --- Setup Iniziale e Listener DOMContentLoaded ---
    function initialize() {
        console.log("INFO: Initializing CONDORSPACE V2.12.1...");
        if (!assignElements()) { console.error("FATAL: Initialization failed: DOM elements missing."); return; }
        AudioSystem.init(() => {
            console.log("INFO: Audio system initialized (state: " + AudioSystem.context?.state + ").");
            displayHighScores();
            if(titleLogoCanvas) drawCondorspaceTitleLogo(titleLogoCanvas);
            setupButtonListeners(); // Listener pulsanti gioco
            
            const systemStartButton = document.getElementById('systemStartButton');
            if (systemStartButton) {
                systemStartButton.onclick = () => {
                    console.log("System Start Button clicked.");
                    AudioSystem.playButtonSound(); // Suono per questo pulsante
                    AudioSystem.resumeContext(() => { // Assicura che l'audio sia attivo
                        if(systemStartButton) systemStartButton.remove();
                        // Inizializza elementi grafici che dipendono da canvas/DOM pronti
                        initCrystalSystem(); // Prima di createStars/Planets se ne fanno uso
                        createStars();
                        createInitialPlanets();
                        if(ctx && canvas) drawBackground();
                        showParallaxSplashScreen(); // Avvia la sequenza con lo splash Parallax
                    });
                };
            } else { console.error("FATAL: System Start Button non trovato!"); }
        });
        addGameEventListeners();
    }

    function showParallaxSplashScreen() {
        parallaxLogoSplashContainer = document.getElementById('parallaxLogoSplashContainer');
        if (!parallaxLogoSplashContainer) { console.error("Parallax Splash Container mancante, avvio intro testuale."); startIntroSequence(); return; }
        console.log("Mostra Parallax Splash Screen...");
        parallaxLogoSplashContainer.classList.add('visible');
        AudioSystem.playParallaxSplashMusic(); // Avvia MP3 N.1 (parallax_logo.mp3)

        setTimeout(() => {
            parallaxLogoSplashContainer.style.opacity = '0';
            setTimeout(() => {
                if(parallaxLogoSplashContainer) parallaxLogoSplashContainer.style.display = 'none';
                AudioSystem.stopAllMP3Music(500); // Ferma MP3 N.1 con fade
                setTimeout(() => {
                    startIntroSequence(); // Avvia intro testuale (che avvierà MP3 N.2)
                }, 500); // Attesa per fade out
            }, 500);
        }, 3500); // Durata splash Parallax
    }

    function setupButtonListeners() {
        if(startButton){startButton.onclick=()=>{if(startButton.disabled)return;startButton.disabled=true;startButton.textContent="Avvio...";AudioSystem.playButtonSound();AudioSystem.resumeContext(()=>{AudioSystem.stopAllMP3Music(200);startGame();});};}
        if(restartButton){restartButton.onclick=()=>{if(!gameOverOverlay||gameOverOverlay.style.display==='none')return;AudioSystem.playButtonSound();gameOverOverlay.style.display="none";if(mainLayout)mainLayout.classList.add('visible');if(ctx&&canvas){ctx.fillStyle="#050510";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#aaccff";ctx.textAlign="center";ctx.font="20px VT323";ctx.fillText("Riavvio...",canvas.width/2,canvas.height/2);ctx.textAlign="left";}startGame(true);};}
        if(saveScoreButton){saveScoreButton.onclick=()=>{AudioSystem.playButtonSound();submitHighScore();};}
        if(playerNameInput){playerNameInput.onkeyup=(e)=>{if(e.key==="Enter")submitHighScore();};}
    }
    function addGameEventListeners(){window.addEventListener('keydown',handleKeyDown);window.addEventListener('keyup',handleKeyUp);window.addEventListener('keydown',function(e){if(e.key===" "&&document.activeElement!==playerNameInput&&(!game.running||game.paused)&&!window.introOver)e.preventDefault();});window.addEventListener('blur',()=>{if(game.running&&!game.paused&&!game.isGameOver)pauseGame();});window.addEventListener('error',e=>{console.error("Unhandled error:",e.message,e.filename,e.lineno);if(!game.errorNotified)game.errorNotified=true;});}

    // --- Avvio Inizializzazione ---
    document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>